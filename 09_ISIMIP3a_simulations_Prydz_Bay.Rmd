---
title: "R Notebook"
output: html_notebook
---

*Steady-state paper*

- Ecosystem structure assessment - trophic pyramid? Food web change (Annabelle's diagrams)
- T-opt, constant temperature experiment for mammals (use an array of constant temperature to ensure consistent temp)

Goldbogon paper - why are whales the size they are? Food limitation - can test this by adjusting kappa.

What about temperature effects, if we leave kappa constant but change temperature

The metabolic and encounter rate scalars, what shape should they be? Test it via density of prey and temperature effects. Indirect effects of food web

*To do*

  - Upgrade temperature forcing to use thetao output
  - Reduce reliance on resource spectrum: 
    - reduce maximum size of resource spectrum
    - reduce interaction strength of predators with resource
    - as mesozooplankton are included in the plankton forcing, should remove this group from predators * Can remove mesozoo from plankton forcing.
  - Remove temperature effect for endotherms
    - Either 1) use a mean temperature for the whole time-series for each endotherm or 2) switch off temp-effect for endotherms

    
Return to initial stage of establishing a steady-state (i.e., can use calibrate biomass and change kappa etc.)
Then make sure to update initial n_pp_array with the new steady state initial_n_pp 

Check feeding level first and growth after any changes to kappa. 
matchGrowth might be useful at a later stage once reproduction parameters are in a better state

Wait until the final step until adjusting fishing/catchability - yield curves at the end right before simulations
    

Set up the environment:
```{r}
# Load libraries
# library(remotes)
# remotes::install_github("sizespectrum/therMizer")
library(therMizer)
library(mizerExperimental)
library(tidyverse)
```

Load steady therMizer parameters:
Temperature and resource information included
```{r}
# Generate parameters
# params <- readRDS("therMizer_params_v04.RDS")

params <- readRDS("params_07_06_2024.rds")
```

Checking what units the biomass observations are in
```{r}
params@species_params$biomass_observed
```
'biomass_observed' is grams per model domain


Load catch data
```{r}
yield_timeseries <- read.csv("FishMIP_fishing_data/catch_timeseries.csv")

rownames(yield_timeseries) <- yield_timeseries$Year

yield_timeseries <- yield_timeseries[,-1]

species_names <- species_params(params)$species

colnames(yield_timeseries) <- species_names

yield_array <- as(yield_timeseries, "matrix")
```


Set up time steps
```{r}
time_steps <- 1961:2010

# time_steps <- seq(as.Date("1961-01-01"),as.Date("2010-12-01"),by="months")
```




## plankton forcing data
Set up the resource:
```{r}
isimip_plankton <- read.table("GFDL_resource_spectra_annual.dat") # log10 abundance
# isimip_plankton <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_w_full_142.dat") # log10 abundance

isimip_plankton <- as(isimip_plankton, "matrix")
sizes <- params@w_full
rownames(isimip_plankton) <- time_steps
colnames(isimip_plankton) <- sizes # signif(sizes, 6)

dim(isimip_plankton)
```



```{r}
n_pp_array <- array(NA, dim = c(length(time_steps), length(sizes)), dimnames = list(time = time_steps, w = sizes)) # setup an empty array for the corrected plankton

n_pp_array_test <- array(NA, dim = c(length(time_steps), length(sizes)), dimnames = list(time = time_steps, w = sizes)) # setup an empty array for the corrected plankton

# Fill array
n_pp_array[1,] <- isimip_plankton[1,]
 for (t in seq(1,length(time_steps) - 1,1)) {
   n_pp_array[t + 1,] <- isimip_plankton[t + 1,]
 }


## Updated step from Julia/Ezekiel May 2024
 n_pp_array_test[1,] <- (isimip_plankton[1,] - colMeans(isimip_plankton[,])) + log10(params@initial_n_pp*params@dw_full)
for (t in seq(1,length(time_steps) - 1,1)) {
  n_pp_array_test[t + 1,] <- (isimip_plankton[t,]  - colMeans(isimip_plankton[,])) +  log10(params@initial_n_pp*params@dw_full)
 }


head(n_pp_array[1,]) #make it comparible
head(n_pp_array_test[1,])
# head(initialNResource(params))

head(n_pp_array[50,]) #make it comparible
head(n_pp_array_test[50,])
```

## temperature forcing data

```{r}
# tos <- readRDS("FishMIP_Temperature_Forcing/tos.rds")
# t500m <- readRDS("FishMIP_Temperature_Forcing/t500m.rds")
# t1000m <- readRDS("FishMIP_Temperature_Forcing/t1000m.rds")
# t1500m <- readRDS("FishMIP_Temperature_Forcing/t1500m.rds")
# tob <- readRDS("FishMIP_Temperature_Forcing/tob.rds")

tos <- readRDS("FishMIP_Temperature_Forcing/tos_annual.rds")
t500m <- readRDS("FishMIP_Temperature_Forcing/t500m_annual.rds")
t1000m <- readRDS("FishMIP_Temperature_Forcing/t1000m_annual.rds")
t1500m <- readRDS("FishMIP_Temperature_Forcing/t1500m_annual.rds")
tob <- readRDS("FishMIP_Temperature_Forcing/tob_annual.rds")

# tos <- readRDS("FishMIP_Temperature_Forcing/WAO_corrected/tos_annual_WAO_corrected.rds")
# t500m <- readRDS("FishMIP_Temperature_Forcing/WAO_corrected/t500m_annual_WAO_corrected.rds")
# t1000m <- readRDS("FishMIP_Temperature_Forcing/WAO_corrected/t1000m_annual_WAO_corrected.rds")
# t1500m <- readRDS("FishMIP_Temperature_Forcing/WAO_corrected/t1500m_annual_WAO_corrected.rds")
# tob <- readRDS("FishMIP_Temperature_Forcing/WAO_corrected/tob_annual_WAO_corrected.rds")

ocean_temp <- abind::abind(tos,t500m,t1000m, t1500m, tob, along = 2)

realm_names <- c("tos","t500m","t1000m", "t1500m", "tob")

colnames(ocean_temp) <- realm_names
rownames(ocean_temp) <- time_steps
```


#vertical_migration array set up----
```{r}
realm_names <- c("tos","t500m","t1000m", "t1500m", "tob")
colnames(ocean_temp) <- realm_names
species_names <- as.character(params@species_params$species)
sizes <- params@w

vertical_migration_array <- array(0, dim = (c(length(realm_names),
                                              length(species_names), length(sizes))),
                                  dimnames = list(realm = realm_names, sp = species_names,
                                                  w = signif(sizes, 3)))
```


```{r}
zone01 <- which(realm_names =="tos")
zone02 <- which(realm_names == "t500m")
zone03 <- which(realm_names =="t1000m")
zone04 <- which(realm_names == "t1500m")
zone05 <- which(realm_names == "tob")
```



```{r}
#mesozooplankton
MesZoo <- which(species_names=="mesozooplankton")
vertical_migration_array[zone01, MesZoo, ] <- 0.25
vertical_migration_array[zone02, MesZoo, ] <- 0.25
vertical_migration_array[zone03, MesZoo, ] <- 0.25
vertical_migration_array[zone04, MesZoo, ] <- 0.25
vertical_migration_array[zone05, MesZoo, ] <- 0
#other krill
Oth_krill <- which(species_names=="other krill")
vertical_migration_array[zone01, Oth_krill, ] <- 0.25
vertical_migration_array[zone02, Oth_krill, ] <- 0.25
vertical_migration_array[zone03, Oth_krill, ] <- 0.25
vertical_migration_array[zone04, Oth_krill, ] <- 0.25
vertical_migration_array[zone05, Oth_krill, ] <- 0
#other macrozooplankton
Oth_MacroZoo <- which(species_names=="other macrozooplankton")
vertical_migration_array[zone01, Oth_MacroZoo, ] <- 0.25
vertical_migration_array[zone02, Oth_MacroZoo, ] <- 0.25
vertical_migration_array[zone03, Oth_MacroZoo, ] <- 0.25
vertical_migration_array[zone04, Oth_MacroZoo, ] <- 0.25
vertical_migration_array[zone05, Oth_MacroZoo, ] <- 0
#antarctic krill
Ant_krill <- which(species_names=="antarctic krill")
vertical_migration_array[zone01, Ant_krill, ] <- 0.25
vertical_migration_array[zone02, Ant_krill, ] <- 0.25
vertical_migration_array[zone03, Ant_krill, ] <- 0.25
vertical_migration_array[zone04, Ant_krill, ] <- 0.25
vertical_migration_array[zone05, Ant_krill, ] <- 0
#salps
salps <- which(species_names=="salps")
vertical_migration_array[zone01, salps, ] <- 0.25
vertical_migration_array[zone02, salps, ] <- 0.25
vertical_migration_array[zone03, salps, ] <- 0.25
vertical_migration_array[zone04, salps, ] <- 0.25
vertical_migration_array[zone05, salps, ] <- 0
#mesopelagic fishes
MesoFish <- which(species_names=="mesopelagic fishes")
vertical_migration_array[zone01, MesoFish, ] <- 0.2
vertical_migration_array[zone02, MesoFish, ] <- 0.4
vertical_migration_array[zone03, MesoFish, ] <- 0.4
vertical_migration_array[zone04, MesoFish, ] <- 0
vertical_migration_array[zone05, MesoFish, ] <- 0
#bathypelagic fishes
BathyFish <- which(species_names=="bathypelagic fishes")
vertical_migration_array[zone01, BathyFish, ] <- 0
vertical_migration_array[zone02, BathyFish, ] <- 0.15
vertical_migration_array[zone03, BathyFish, ] <- 0.15
vertical_migration_array[zone04, BathyFish, ] <- 0.35
vertical_migration_array[zone05, BathyFish, ] <- 0.35
#shelf and coastal fishes
SCFish <- which(species_names=="shelf and coastal fishes")
vertical_migration_array[zone01, SCFish, ] <- 0.2
vertical_migration_array[zone02, SCFish, ] <- 0.2
vertical_migration_array[zone03, SCFish, ] <- 0.2
vertical_migration_array[zone04, SCFish, ] <- 0.2
vertical_migration_array[zone05, SCFish, ] <- 0.2
#flying birds
Birds <- which(species_names=="flying birds")
vertical_migration_array[zone01, Birds, ] <- 1
vertical_migration_array[zone02, Birds, ] <- 0
vertical_migration_array[zone03, Birds, ] <- 0
vertical_migration_array[zone04, Birds, ] <- 0
vertical_migration_array[zone05, Birds, ] <- 0
#small divers
Sm_divers <- which(species_names=="small divers")
vertical_migration_array[zone01, Sm_divers, ] <- 1
vertical_migration_array[zone02, Sm_divers, ] <- 0
vertical_migration_array[zone03, Sm_divers, ] <- 0
vertical_migration_array[zone04, Sm_divers, ] <- 0
vertical_migration_array[zone05, Sm_divers, ] <- 0
#squids
squids <- which(species_names=="squids")
vertical_migration_array[zone01, squids, ] <- 0.2
vertical_migration_array[zone02, squids, ] <- 0.2
vertical_migration_array[zone03, squids, ] <- 0.2
vertical_migration_array[zone04, squids, ] <- 0.2
vertical_migration_array[zone05, squids, ] <- 0.2
#toothfishes
toothfishes <- which(species_names=="toothfishes")
vertical_migration_array[zone01, toothfishes, ] <- 0.2
vertical_migration_array[zone02, toothfishes, ] <- 0.2
vertical_migration_array[zone03, toothfishes, ] <- 0.2
vertical_migration_array[zone04, toothfishes, ] <- 0.2
vertical_migration_array[zone05, toothfishes, ] <- 0.2
#leopard seals
seals <- which(species_names=="leopard seals")
vertical_migration_array[zone01, seals, ] <- 0.5
vertical_migration_array[zone02, seals, ] <- 0.5
vertical_migration_array[zone03, seals, ] <- 0
vertical_migration_array[zone04, seals, ] <- 0
vertical_migration_array[zone05, seals, ] <- 0
#medium divers
Md_divers <- which(species_names=="medium divers")
vertical_migration_array[zone01, Md_divers, ] <- 0.5
vertical_migration_array[zone02, Md_divers, ] <- 0.5
vertical_migration_array[zone03, Md_divers, ] <- 0
vertical_migration_array[zone04, Md_divers, ] <- 0
vertical_migration_array[zone05, Md_divers, ] <- 0
#large diver
Lrg_divers <- which(species_names=="large divers")
vertical_migration_array[zone01, Lrg_divers, ] <- 0.5
vertical_migration_array[zone02, Lrg_divers, ] <- 0.5
vertical_migration_array[zone03, Lrg_divers, ] <- 0
vertical_migration_array[zone04, Lrg_divers, ] <- 0
vertical_migration_array[zone05, Lrg_divers, ] <- 0
#minke whales
minke <- which(species_names=="minke whales")
vertical_migration_array[zone01, minke, ] <- 0.4
vertical_migration_array[zone02, minke, ] <- 0.4
vertical_migration_array[zone03, minke, ] <- 0.1
vertical_migration_array[zone04, minke, ] <- 0.1
vertical_migration_array[zone05, minke, ] <- 0
#orca
orca <- which(species_names=="orca")
vertical_migration_array[zone01, orca, ] <- 0.4
vertical_migration_array[zone02, orca, ] <- 0.4
vertical_migration_array[zone03, orca, ] <- 0.1
vertical_migration_array[zone04, orca, ] <- 0.1
vertical_migration_array[zone05, orca, ] <- 0
#sperm whales
sperm <- which(species_names=="sperm whales")
vertical_migration_array[zone01, sperm, ] <- 0.3
vertical_migration_array[zone02, sperm, ] <- 0.3
vertical_migration_array[zone03, sperm, ] <- 0.2
vertical_migration_array[zone04, sperm, ] <- 0.2
vertical_migration_array[zone05, sperm, ] <- 0
#baleen whales
Baleen <- which(species_names=="baleen whales")
vertical_migration_array[zone01, Baleen, ] <- 0.4
vertical_migration_array[zone02, Baleen, ] <- 0.4
vertical_migration_array[zone03, Baleen, ] <- 0.1
vertical_migration_array[zone04, Baleen, ] <- 0.1
vertical_migration_array[zone05, Baleen, ] <- 0
```


```{r}
exposure_array <- array(0, dim = (c(length(realm_names), length(species_names))), 
                  dimnames = list(realm = realm_names, sp = species_names)) # realm x species

for (r in seq(1,length(realm_names),1)) {
    for (s in seq(1,length(species_names),1)) {
        if (any(vertical_migration_array[r,s,] > 0)) {
            exposure_array[r,s] = 1
        }
    }
}
```

## Fishing effort forcing

```{r}
time_steps_effort <- 1961:2010
isimip_effort <- read.csv("FishMIP_fishing_data/effort_array.csv")

years <- isimip_effort[,1]

isimip_effort <- isimip_effort[,-1]
rownames(isimip_effort) <- years

# colnames(isimip_effort) <- rownames(gear_params(params))
# colnames(isimip_effort) <-  gear_params(params)$gear # rep("kinfe_edge_gear",19)
 # colnames(isimip_effort) <- rep("knife_edge_gear",19)
 
for (i in 1:ncol(isimip_effort)) {
  colnames(isimip_effort)[i] <- "knife_edge_gear"
}

head(isimip_effort)
glimpse(isimip_effort)
dim(isimip_effort)

effort_1961_2010 <- isimip_effort[-c(1:31,82:90),]

isimip_effort_array <- as(effort_1961_2010, "matrix")

gear_name = colnames(isimip_effort)


effort_array <- array(NA, c(length(time_steps_effort), length(gear_name)), dimnames = list(time = time_steps_effort, gear = gear_name))
effort_array[1,] = isimip_effort_array[1,]
for (t in seq(1,length(time_steps_effort) - 1, 1)) {
  effort_array[t + 1,] <- isimip_effort_array[t + 1,]
}

effort_array[is.na(effort_array)] <- 0
```


```{r}
gear_params(params)
```



Add temperature and resource information to the parameters:
```{r}
plotTherPerformance(params)
```


```{r}
params_v2 <- params

gear_params(params_v2)$catchability <- ifelse(gear_params(params_v2)$catchability > 0, 0.5, gear_params(params_v2)$catchability)

gear_params(params)$catchability
gear_params(params_v2)$catchability
```


```{r}
dim(effort_array)
head(effort_array)
effort_array[1,]

# gear_params(params_v2)$gear <- gear_params(params_v2)$species
gear_params(params)$gear <- gear_params(params)$species
# gear_params(params_steady_F)$gear <- gear_params(params_steady_F)$species

# gear_name = gear_params(params_steady_F)$gear
# gear_name = gear_params(params_v2)$gear
gear_name = gear_params(params)$gear
colnames(effort_array) <- gear_name
head(effort_array)
# 
# gear_params(params)$gear <- gear_name
# gear_params(params)$gear
# head(effort_array)

# saveRDS(effort_array, "effort_array_therMizer.RDS")
```


```{r}
# params_v2@initial_effort <- effort_array[1,]

ref_period_effort <- colMeans(effort_array[c(40:50),])
model_period_effort <- colMeans(effort_array)

initial_effort_updated <- ref_period_effort
initial_effort_updated[c(4,7,17,18)] <- model_period_effort[c(4,7,17,18)]

# params_v2@initial_effort <- initial_effort_updated
params@initial_effort <- initial_effort_updated
# params_v2@initial_effort[c(4,7,11,18)] <- model_period_effort[c(4,7,11,18)]

params_v2 <- steady(params_v2, t_max = 1000)


# sim_ref <- mizer::project(params_v2, t_max = 200, effort = initial_effort_updated)
sim_ref <- mizer::project(params, t_max = 200, effort = initial_effort_updated)


plotYieldObservedVsModel(params_v2)
plotYieldObservedVsModel(sim_ref, ratio = T)
gear_params(sim_ref@params)$catchability
plotYield(sim_ref)
```

```{r}
#Test ratio
ratio<- plotYieldObservedVsModel(params_v2, return_data = TRUE)$ratio
# gear_params(params_v2)$catchability[c(7,8,12,16,19)]<-gear_params(params_v2)$catchability[c(7,8,12,16,19)]/ratio
gear_params(params)$catchability[c(7,8,12,16,19)]<-gear_params(params)$catchability[c(7,8,12,16,19)]/ratio

# gear_params(params_v2)$catchability <- ifelse(gear_params(params_v2)$catchability == 0.5, 0, gear_params(params_v2)$catchability)

# gear_params(params_v2)$catchability[c(8)] <- gear_params(params_v2)$catchability[c(8)] * 1.5 # shelf and coastal fishes
gear_params(params_v2)$catchability[c(8)] <- 1.267937e-05 * 3 # shelf and coastal fishes

# gear_params(params_v2)$catchability[c(16)] <- gear_params(params_v2)$catchability[c(16)] * 1.5 # minke whales
gear_params(params_v2)$catchability[c(16)] <- 0.354628 * 2 # minke whales

gear_params(params_v2)$catchability[c(11)] <- 0.000005 # squids

gear_params(params_v2)$catchability[c(4)] <- 0.005 # ant krill

gear_params(params_v2)$catchability[c(17)] <- 0.1 # orca

gear_params(params_v2)$catchability[c(18)] <- 1 # sperm whales

params_v3 <- steady(params_v2)

plotYieldObservedVsModel(params_v3, ratio=T)

sim_ref_v2 <- mizer::project(params_v3, t_max = 200)

plotYield(sim_ref_v2)

# ref_period_effort
```


```{r}
ratio_v2<- plotYieldObservedVsModel(params_v3, return_data = TRUE)$ratio

# gear_params(params_v3)$catchability[c(7,8,12,16,19)]<-gear_params(params_v3)$catchability[c(7,8,12,16,19)]/ratio_v2


gear_params(params_v3)$species[12]
gear_params(params_v3)$catchability[12]

ratio_v2[3]

gear_params(params_v3)$catchability[12]<-gear_params(params_v3)$catchability[c(12)]/ratio_v2[3]

params_v4 <- steady(params_v3)

plotYieldObservedVsModel(params_v4, ratio=T)


ratio_v3 <- plotYieldObservedVsModel(params_v4, return_data = TRUE)$ratio

gear_params(params_v4)$catchability[c(7,8,12,16,19)]<-gear_params(params_v4)$catchability[c(7,8,12,16,19)]/ratio_v3

params_v5 <- steady(params_v4)

plotYieldObservedVsModel(params_v5, ratio=T)

sim_ref_v3 <- mizer::project(params_v5, t_max = 200)

plotYield(sim_ref_v3)

```


```{r}
# getReproductionLevel(params_v5)
# params_v5@species_params$erepro

getReproductionLevel(params)
params@species_params$erepro

# saveRDS(params_v5, "params_04_06_2024_v3.rds")

```
Adjust reproduction level and erepro to be within 'realistic' bounds

```{r}
# new_repro_level <- getReproductionLevel(params_v5)
# new_repro_level[c(17)] <- 0.999999
# 
# new_erepro_level <- species_params(params_v5)$erepro
# # new_erepro_level[c(17,18)] <- 0.999999
# new_erepro_level[c(13,16,18)] <- 0.999999
```

## steady with yield
```{r}
# params_v6 <- setBevertonHolt(params_v5, reproduction_level = new_repro_level)
# params_v7 <- setBevertonHolt(params_v6, erepro = new_erepro_level)
# 
# params_v8 <- steady(params_v7, t_max = 200, preserve = c("erepro"))
# 
# # saveRDS(params_v8, "params_04_06_2024.rds")
# 
# getReproductionLevel(params_v8)
# species_params(params_v8)$erepro
# 
# params_v8 <- params_v8 %>% matchBiomasses() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, preserve = c("erepro")) %>%
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>%
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#   matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro"))
# 
# plotBiomassObservedVsModel(params_v8)
# # params_v8@initial_effort
# species_params(params_v8)$erepro
# getReproductionLevel(params_v8)
```

matchBiomass and matchGrowth
```{r}
# params_v9 <- params_v8 %>% matchBiomasses() %>% matchGrowth() %>% steady(t_max = 200)
#   
#   
#   # matchBiomasses() %>% matchGrowth() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, preserve = c("erepro")) %>%
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>%
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#   #  matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#   #  matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#   #  matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#   #  matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#   #  matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#   # matchBiomasses() %>% matchGrowth() %>%steady(t_max = 500, tol = 0.001, preserve = c("erepro"))
```


```{r}
# sim_steady <- project(params_v8, t_max = 750)
# plot(sim_steady)
# plotBiomassRelative(sim_steady)
```

```{r}

```


# Recalibrate parameters - THIS PART IS FOR THE STEADY STATE only

For this step, we re-estimate the reproduction/biomass parameters using time-averaged forcing data for the first decade (1961 - 1970)

First, reset initial n_pp to be time averaged value of plankton. 

```{r}
params_steady <- params
years_to_use<-as.character(2001:2010)


# initialNResource(params)[which(w_full(params) < 100)]<-10^colMeans(n_pp_array[years_to_use,])[which(w_full(params) < resource_params(params)$w_pp_cutoff)]
# initialNResource(params_updated_n_pp)[which(w_full(params_updated_n_pp) < 100)]<- 10^colMeans(n_pp_array[years_to_use,])[which(w_full(params_updated_n_pp) < 100)]

initialNResource(params_steady)[which(w_full(params_steady) < 100)]<- 10^colMeans(n_pp_array[years_to_use,])[which(w_full(params_steady) < 100)]/params_steady@dw_full # normalise the plankton spectrum to match the therMizer plankton_forcing()
#need to cut resource at 100g

initialNResource(params_steady)[which(w_full(params_steady) >=resource_params(params_steady)$w_pp_cutoff)]<-0.0 # sets all above 100g to 0


# same with initial effort
initial_effort(params_steady)<-colMeans(effort_array[years_to_use,])

# use steady-state period plankton and temperatures
params_pre <- upgradeTherParams(params_steady, ocean_temp_array = ocean_temp[years_to_use,],n_pp_array = n_pp_array[years_to_use,],
      # vertical_migration_array = vertical_migration_array,
                            # exposure_array = ESS_exposure, 
                            aerobic_effect = TRUE, metabolism_effect = TRUE)

```

## steady with yield
```{r}
# params_v6 <- setBevertonHolt(params_v5, reproduction_level = new_repro_level)
# params_v7 <- setBevertonHolt(params_v6, erepro = new_erepro_level)
# 
params_pre_v2 <- steady(params_pre, t_max = 200, tol = 0.01)

# getReproductionLevel(params_pre_v2)
species_params(params_pre_v2)$erepro
```


```{r}
# # new_repro_level <- getReproductionLevel(params_pre_v2)
# # new_repro_level[c(17)] <- 0.999999
# 
# new_erepro_level <- species_params(params_pre_v2)$erepro
# # new_erepro_level[c(17,18)] <- 0.999999
# # new_erepro_level[c(16)] <- 0.999999
# 
# params_pre_v3 <- setBevertonHolt(params_pre_v2, erepro = new_erepro_level)
# 
# species_params(params_pre_v3)$erepro
```

```{r}
# params_pre_v3 <- steady(params_pre_v3, t_max = 500, tol = 0.005)
```

```{r}
# new_erepro_level <- species_params(params_pre_v3)$erepro
# # new_erepro_level[c(17,18)] <- 0.999999
# # new_erepro_level[c(13,16)] <- 0.9
# new_erepro_level[c(16)] <- 0.999999
# 
# params_pre_v3 <- setBevertonHolt(params_pre_v3, erepro = new_erepro_level)
# 
# species_params(params_pre_v3)$erepro
```


```{r}
# getReproductionLevel(params_pre_v3)
# species_params(params_pre_v3)$erepro
```



```{r}
# getReproductionLevel(params_pre_v3)
# species_params(params_pre_v3)$erepro
# 
# params_pre_v3 <- params_pre %>% matchBiomasses() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, preserve = c("erepro")) %>%
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>%
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>%
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 200, tol = 0.005, preserve = c("erepro")) %>% 
#   matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#    matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>%
#   matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro"))
# 
# plotBiomassObservedVsModel(params_pre_v3)
# # params_pre_v3@initial_effort
# species_params(params_pre_v3)$erepro
# getReproductionLevel(params_pre_v3)
```

```{r}
# sim_steady <- project(params_pre_v3, t_max = 1000)
# plot(sim_steady)
```

```{r}
# sim_1.1 <- project(params_pre_v3, t_max = 500, 
#                          initial_n = sim_steady@n[1000,,])
# 
# plot(sim_1.1)
```


```{r}
# params_v9 <- tuneParams(params_v8)
```



```{r}
IWC_effort_full <- read.csv("FishMIP_fishing_data/IWC_effort.csv")

glimpse(IWC_effort_full)
```

```{r}
IWC_effort_full_tidy <- IWC_effort_full %>% 
  select(Year, Species, effort_standard) %>% 
  filter(Year <= 1960) %>% 
  group_by(Species) %>% 
  summarise(mean_effort = mean(effort_standard))

IWC_effort_full_tidy
```



```{r}
paramsT <- upgradeTherParams(params_pre_v2, 
                            ocean_temp_array = ocean_temp,
                            n_pp_array = n_pp_array, 
                            vertical_migration_array = vertical_migration_array,
                            exposure_array = exposure_array,
                            aerobic_effect = TRUE, metabolism_effect = TRUE)

```

## steady with biomass

```{r}

# params_steady_F <- steady(paramsT, t_max = 200, preserve = c("erepro"))
params_steady_F <- steady(paramsT, t_max = 200, tol = 0.001)
# params_steady_F <- steady(paramsT, t_max = 200)


getReproductionLevel(params_steady_F)
species_params(params_steady_F)$erepro

params_steady_F_v2 <- params_steady_F %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.001, preserve = c("erepro"))

getReproductionLevel(params_steady_F_v2)
species_params(params_steady_F_v2)$erepro

plotBiomassObservedVsModel(params_steady_F_v2)
params_steady_F_v2@initial_effort
```

```{r}
sim_1.2 <- project(params_steady_F_v2, t_max = 500)
 
plot(sim_1.2)                        
```

```{r}

initial_effort_1961 <- effort_array[1,]
no_effort <- rep(0,19)

params_exp_F <- params_steady_F_v2
params_exp_noF <- params_steady_F_v2

params_exp_F@initial_effort <- initial_effort_1961
params_exp_noF@initial_effort <- no_effort

params_steady_F_init1961 <- params_exp_F %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>%
   matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro"))
  
  
params_steady_noF <- params_exp_noF %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 200, tol = 0.01, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 500, tol = 0.005, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>%
   matchBiomasses() %>% steady(t_max = 1000, tol = 0.003, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.002, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>% 
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro")) %>%
  matchBiomasses() %>% steady(t_max = 1000, tol = 0.001, preserve = c("erepro"))

sim_exp_F <- project(params_steady_F_init1961, t_max = 500)
sim_exp_noF <- project(params_steady_noF, t_max = 500)

plot(sim_exp_F)
plot(sim_exp_noF)

plotBiomassRelative(sim_exp_F)
plotBiomassRelative(sim_exp_noF)

```



# Using steady-state from reference period (2010-2019)
```{r}
params_steady_F_init1961 <- projectToSteady(params_steady_F_v2, t_max = 200, tol = 0.001, effort = effort_array[1,], return_sim = T)
params_steady_noF <- projectToSteady(params_steady_F_v2, t_max = 200, tol = 0.001, effort = 0, return_sim = T)
# 
# # # Include a validation run with F = 0.2 (the estimated F for most of the species modeled, per stock assessments)
# # params_steady_validate <- projectToSteady(paramsT, t_max = 50, effort = 0.2) 
# # sim_steady_validate <- projectToSteady(paramsT, t_max = 50, effort = 0.2, return_sim = TRUE) # replace this with the calibration matchBiomass() steps from Ezekiel's
# # 
# # # Test to see how things look
# plot(params_steady_F_init1961)
# plot(params_steady_noF)
# # plot(sim_steady_validate)
```


Initial effort from the reference period used to create steady-state so that the effort 

Effort from 1961 to steady state and then use


```{r}
projection_steady_F <- readRDS("ISIMIP3a_1961_2010_fishing.rds")
projection_steady_noF <- readRDS("ISIMIP3a_1961_2010_no_fishing.rds")
```

Run simulations:
```{r}
params_steady_F <- projection_steady_F@params
params_steady_noF <- projection_steady_noF@params

```

Use the first year of the n_pp_array to achieve steady state to start the projections
```{r}
params <- params_steady_noF
years_to_use <- as.character(1961:1970)

initialNResource(params)[which(w_full(params) < 100)]<- 10^colMeans(n_pp_array[years_to_use,])[which(w_full(params) < 100)]/params@dw_full # normalise the plankton spectrum to match the therMizer plankton_forcing()
#need to cut resource at 100g
initialNResource(params)[which(w_full(params) >=resource_params(params)$w_pp_cutoff)]<-0.0 # sets all above 100g to 0


# same with initial effort
initial_effort(params)<-colMeans(effort_array[years_to_use,])

# Replace temp array with the same values


ocean_temp_mean <- ocean_temp
  for (t in seq(1,dim(ocean_temp_mean)[1])) {
   ocean_temp_mean[t,] <- colMeans(ocean_temp[years_to_use,])
 }

n_pp_array_mean <- n_pp_array
  for (t in seq(1,dim(n_pp_array_mean)[1])) {
   n_pp_array_mean[t,] <- colMeans(n_pp_array[years_to_use,])
 }

# use pre-collapse plank and temperatures
params_pre <- upgradeTherParams(params, ocean_temp_array = ocean_temp_mean[years_to_use,],n_pp_array = n_pp_array_mean[years_to_use,],
      # vertical_migration_array = vertical_migration_array,
                            # exposure_array = ESS_exposure, 
                            aerobic_effect = TRUE, metabolism_effect = TRUE)
```


```{r}
params_proj_steady <- projectToSteady(params_pre, t_max = 500, tol = 0.001, effort = 0, return_sim = T)

sim_F_v1 <- project(params_proj_steady, t_max = 500, effort = 0)

plot(sim_F_v1)

```

```{r}
# params_proj_steady_v2 <- projectToSteady(params_proj_steady, t_max = 500, tol = 0.001, effort = 0, initia return_sim = T)

initialN(params_proj_steady) <- unlist(sim_F_v1@n[500,,])

sim_F_v2 <- project(params_proj_steady, t_max = 200, initial_n = sim_F_v1@n[500,,])

plot(sim_F_v2)
```



Plot project to steady params
```{r}
plot(params_proj_steady)
```



```{r}

# And do a simulation using the steady parameters
projection_steady_F <- mizer::project(params_steady_F_init1961, t_max = 50, effort = effort_array)
projection_steady_noF <- mizer::project(params_steady_noF, t_start = 1961, t_max = 49,  effort = 0)
# projection_steady_F_init1961 <- mizer::project(params_steady_F_init1961, t_max = 50, effort = effort_array)

# projection_steady_validate <- mizer::project(params_steady_validate, t_max = 50,  effort = 0.2)

# Test to see how things look
plot(projection_steady_F)
plot(projection_steady_noF)
# plot(projection_steady_F_init1961)
# plot(projection_steady_validate)

plotYield(projection_steady_F)
# plotYield(projection_steady_F_init1961)

plotlyBiomass(projection_steady_F)
plotlyBiomass(projection_steady_noF)
# plotlyBiomass(projection_steady_F_init1961)

plotlyBiomassRelative(projection_steady_F)
plotlyBiomassRelative(projection_steady_noF)
# plotlyBiomassRelative(projection_steady_F_init1961)



# saveRDS(projection_steady_F, "ISIMIP3a_1961_2010_fishing.rds")
# saveRDS(projection_steady_noF, "ISIMIP3a_1961_2010_no_fishing.rds")

```
Climate data for pre-1961

Take the outputs from controlclim 


Yield from current reference period (2010-2019)
Ratio of time-averaged yield in the ref period compared to the time-averaged yield in the decade prior to start of forcings (1950s) and then correct biomass according to the ratio.

Assumes a linear relationship between the ratio of yield:biomass, not neccessarily linear between yield and biomass.

Fmsy * unfinished biomass = msy (Can we use this to get the biomass from 1950s)?

To run a future projection would want to run historical scenario that ends in 2014 and then leads into the ssp2.6/8.5 GFDL scenarios

Results for presentaiton: 
- fished/unfished biomass. 
- growth plots
- barplots - comparing fished and unfished
- Variety of realised PPMRs
- Ecosystem indicators for mean of first 5 years to last 5 years - with and without fishing 
Time-average biomasses start and finish of time period and with/without fishing
mizer::getCommunitySlope()
mizer::getProportionOfLargeFish() # large animals or select specific species
mizer::getMeanMaxWeight()
mizer::getMeanWeight()

```{r}
projection_steady_F <- readRDS("ISIMIP3a_1961_2010_fishing.rds")
projection_steady_noF <- readRDS("ISIMIP3a_1961_2010_no_fishing.rds")
```


```{r}
p_B_Fishing <- plotBiomass(projection_steady_F) +
  theme_classic() +
  theme(axis.title =  element_text(size=12),
        axis.text  =  element_text(size=10))

p_B_noFishing <- plotBiomass(projection_steady_noF) +
  theme_classic() +
  theme(axis.title =  element_text(size=12),
        axis.text  =  element_text(size=10))

p_B_rel_Fishing <- plotBiomassRelative(projection_steady_F) +
  theme_classic() +
  theme(axis.title =  element_text(size=12),
        axis.text  =  element_text(size=10))

p_B_rel_noFishing <- plotBiomassRelative(projection_steady_noF) +
  theme_classic() +
  theme(axis.title =  element_text(size=12),
        axis.text  =  element_text(size=10))

p_B_Fishing
p_B_noFishing
p_B_rel_Fishing
p_B_rel_noFishing

ggsave("plots/Biomass_Fishing_1961_2010.tiff", plot = p_B_Fishing, units="cm", width=20, height=16, dpi =300)
ggsave("plots/Biomass_No_Fishing_1961_2010.tiff", plot = p_B_noFishing, units="cm", width=20, height=16, dpi =300)
ggsave("plots/Biomass_Relative_Fishing_1961_2010.tiff", plot = p_B_rel_Fishing, units="cm", width=20, height=16, dpi =300)
ggsave("plots/Biomass_Relative_No_Fishing_1961_2010.tiff", plot = p_B_rel_noFishing, units="cm", width=20, height=16, dpi =300)

```

```{r}
plotDietX(projection_steady_F@params)
```


species.labs <- c("Antarctic krill", "Bathypelagic fishes", "Shelf & Coastal fishes", "Squids", "Toothfishes", "Antarctic minke whales", "Orcas", "Sperm whales", "Baleen whales")
names(species.labs) <- c("antarctic krill", "bathypelagic fishes", "shelf and coastal fishes", "squids", "toothfishes", "minke whales", "orca", "sperm whales", "baleen whales")

```{r}
effort_ts <- effort_array %>% 
  melt()

head(effort_ts)

names(effort_ts) <- c("Year", "Species", "Norm_Effort")

effort_ts_tidy <- effort_ts %>% 
  filter(Species == "shelf and coastal fishes" |
           Species == "antarctic krill" |
           Species == "squids" |
           Species == "bathypelagic fishes" |
           Species == "toothfishes" |
           Species == "minke whales" |
           Species == "baleen whales"|
           Species == "orca"|
           Species == "sperm whales") %>%
  filter(!Norm_Effort == 0)

glimpse(effort_ts_tidy)
head(effort_ts_tidy)
```


```{r}
yield_ts <- yield_array %>% 
  melt()

head(yield_ts)

names(yield_ts) <- c("Year", "Species", "Yield")

yield_ts_tidy <- yield_ts %>% 
  # filter(Species == "shelf and coastal fishes" |
  #          Species == "squids" |
  #          Species == "toothfishes" |
  #          Species == "minke whales" |
  #          Species == "baleen whales"|
  #          Species == "sperm whales") %>% 
  filter(!Yield == 0)

glimpse(yield_ts_tidy)
head(yield_ts_tidy)
```


Plot observed yield
```{r}
# New facet label names for species
species.labs <- c("Antarctic krill", "Bathypelagic fishes", "Shelf & Coastal fishes", "Squids", "Toothfishes", "Antarctic minke whales", "Orcas", "Sperm whales", "Baleen whales")
names(species.labs) <- c("antarctic krill", "bathypelagic fishes", "shelf and coastal fishes", "squids", "toothfishes", "minke whales", "orca", "sperm whales", "baleen whales")

# df_mod_yield <- plotYield(projection_steady_F, return_data = T)

p_yield <- 
  plotYield(projection_steady_F) +
  facet_wrap(~Species,scales="free_y",
             labeller = labeller(Species = species.labs)) +
  labs(fill = "Functional group") +
  # facet_wrap(~Species,scales="free_y") +
  geom_point(data = yield_ts_tidy, aes(x = Year, y = Yield, colour = Species), size=1) +
  geom_point(data = yield_ts_tidy, aes(x = Year, y = Yield), shape = 1,size = 1,colour = "black") +
  theme(legend.title = element_text( size=3), legend.text=element_text(size=3)) + 
  geom_vline(aes(xintercept = 1961), linetype = "dashed") + 
  geom_vline(aes(xintercept = 2010), linetype = "dashed") +
  theme_bw() +
  theme(
    legend.position = "none"
  )
  # theme_classic()

p_yield_const_scale <-
  
  plotYield(projection_steady_F) + 
  facet_wrap(~Species,
             labeller = labeller(Species = species.labs)) +
  labs(fill = "Functional group") +
  # facet_wrap(~Species,scales="free_y") +
  geom_point(data = yield_ts_tidy, aes(x = Year, y = Yield, colour = Species), size=1) +
  geom_point(data = yield_ts_tidy, aes(x = Year, y = Yield), shape = 1,size = 1,colour = "black") +
  theme(legend.title = element_text( size=3), legend.text=element_text(size=3)) + 
  geom_vline(aes(xintercept = 1961), linetype = "dashed") + 
  geom_vline(aes(xintercept = 2010), linetype = "dashed") +
  # scale_x_continuous(breaks = c(1930,1945,1961,1985,2010)) +
  # scale_y_log10() +
  theme_bw() +
  theme(
    legend.position = "none"
  )

ggsave("plots/Compare_Modelled_Observed_Yields_low_res.tiff", plot = p_yield, units="cm", width=20, height=16, dpi =150)
# ggsave("plots/Compare_Modelled_Observed_Yields_same_scale.tiff", plot = p_yield_const_scale, units="cm", width=20, height=16, dpi =300)
```


```{r}
# New facet label names for species
species.labs <- c("Antarctic krill", "Bathypelagic fishes", "Shelf & Coastal fishes", "Squids", "Toothfishes", "Antarctic minke whales", "Orcas", "Sperm whales", "Baleen whales")
names(species.labs) <- c("antarctic krill", "bathypelagic fishes", "shelf and coastal fishes", "squids", "toothfishes", "minke whales", "orca", "sperm whales", "baleen whales")

# df_mod_yield <- plotYield(projection_steady_F, return_data = T)

p_effort <-  effort_ts_tidy %>% 
  ggplot() +
  
  # facet_wrap(~Species,scales="free_y") +
  geom_point(data = effort_ts_tidy, aes(x = Year, y = Norm_Effort, colour = Species), size=1) +
  geom_point(data = effort_ts_tidy, aes(x = Year, y = Norm_Effort), shape = 1,size = 1,colour = "black") +
    geom_line(data = effort_ts_tidy, aes(x = Year, y = Norm_Effort, colour = Species), size=1) +
    facet_wrap(~Species,scales="free_y",
             labeller = labeller(Species = species.labs)) +
  labs(fill = "Functional group") +
  theme(legend.title = element_text( size=3), legend.text=element_text(size=3)) + 
  geom_vline(aes(xintercept = 1961), linetype = "dashed") + 
  geom_vline(aes(xintercept = 2010), linetype = "dashed") +
  theme_classic() +
  theme(
    legend.position = "none"
  )

ggsave("plots/Effort_Forcing_low_res.tiff", plot = p_effort, units="cm", width=20, height=16, dpi =150)
```


```{r}
gear_params(projection_steady_F@params)$catchability
```


Results for presentaiton: 
- fished/unfished biomass. 
- growth plots
- barplots - comparing fished and unfished
- Variety of realised PPMRs
- Ecosystem indicators for mean of first 5 years to last 5 years - with and without fishing 
Time-average biomasses start and finish of time period and with/without fishing

```{r}

mizer::getCommunitySlope()
mizer::getProportionOfLargeFish() # large animals or select specific species
mizer::getMeanMaxWeight()
mizer::getMeanWeight()
```


## Mean weights
```{r}
years_comparison <- c("1961","2010")
# getMeanWeight(projection_steady_F, species = c("antarctic krill", "bathypelagic fishes", "shelf and coastal fishes", "squids", "toothfishes", "minke whales", "orca", "sperm whales", "baleen whales"))
getMeanMaxWeight(projection_steady_F, species = c("baleen whales"))[years_comparison,]

# years_comparison_noF <- c("0","50")
# getMeanWeight(projection_steady_noF, species = c("antarctic krill", "bathypelagic fishes", "shelf and coastal fishes", "squids", "toothfishes", "minke whales", "orca", "sperm whales", "baleen whales"))
getMeanMaxWeight(projection_steady_noF, species = c("baleen whales"))[years_comparison,]

getMeanMaxWeight(projection_steady_F, species = c("minke whales"))[years_comparison,]
getMeanMaxWeight(projection_steady_noF, species = c("minke whales"))[years_comparison,]

getMeanMaxWeight(projection_steady_F, species = c("sperm whales"))[years_comparison,]
getMeanMaxWeight(projection_steady_noF, species = c("sperm whales"))[years_comparison,]

```

```{r}
# getProportionOfLargeFish(projection_steady_F, species = c("antarctic krill"), min_w = 0.1, threshold_w = 2)
# getProportionOfLargeFish(projection_steady_noF, species = c("antarctic krill"), min_w = 0.1, threshold_w = 2)

getProportionOfLargeFish(projection_steady_F, species = c("shelf and coastal fishes"), min_w = 10, threshold_w = 1000)
getProportionOfLargeFish(projection_steady_noF, species = c("shelf and coastal fishes"), min_w = 10, threshold_w = 1000)
```

```{r}
getCommunitySlope(projection_steady_F)
getCommunitySlope(projection_steady_noF)

```
-1.017799  25.79908
-1.009425	 25.83120	









