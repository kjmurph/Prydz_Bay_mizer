---
title: "Calibrating a model within therMizer"
author: "Kieran Murphy"
date:  "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

Here I am attempting to incorporate fishing into a mizer params object and achieve a rough steady-state before beginning a full calibration in therMizer.

After the model is calibrated I will use the therMizer temperature comparison protocol and FishMIP protocol to run projections with fishing effort and warming.

## Libraries

```{r}
# remotes::install_github("sizespectrum/therMizer") # if needed
library(therMizer)
# remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
# remotes::install_github("sizespectrum/mizerHowTo")
library(mizerHowTo)
```


## Setup params

```{r}
# params <- readRDS("params/params_optim_v04_w_pp_100.rds")
params <- readRDS("params_latest_xx.RDS") # antarctic krill group

plot(params)
plotFMort(params)
```

```{r}
params@species_params$species
```


Updating biomass_observed, as I made a mistake previously asigning incorrect groups
```{r}
biomass_observed <- c(8.8, #  mesozooplankton
                      1.9, # other krill
                      10, # other macrozooplankton
                      4, # antarctic krill
                      0.652, # salps
                      2.002,   # mesopelagic fishes (balanced model biomass of mesopelagic fishes and antarctic silverfish from McCormack et al. 2020)
                      2.002, # bathypelagic fishes
                      1.93, # shelf and coastal fishes (other fish from McCormack)
                      0.003, # flying birds
                      0.016,  # small divers
                      0.15, # squids
                      0.75, # toothfishes
                      0.002, # leopard seals
                      0.265,  # medium divers
                      0.011, # large divers #is now only elephant seals
                      0.014, # minke whales
                      0.006, # orca
                      0.011, # sperm whales
                      0.127 # baleen whales
                      )
```


```{r}
species_params(params)$biomass_observed <- biomass_observed

species_params(params)$biomass_observed
```

```{r}
params <- steady(params)
params <- matchBiomasses(params)
params <- steady(params)

```
```{r}
params_t1 <- tuneParams(params)
```


```{r}
params_t1@species_params$erepro
```

Optim Round 5

```{r}
vary_df <- data.frame("name" = c("erepro"),
                      "length" = c(19),
                      "lower" = c(0.000001), 
                      "upper" = c(0.999999),
                      "slot" = c("species_params"),
                      "unit" = c("linear"))

vary <- c(params_t1@species_params$erepro)
```


```{r}
tic()
res_int_v5 <- mizerHowTo::fastOptim(params = params,
                 vary = vary,
                 vary_df = vary_df,
                 errorFun = mizerHowTo::getErrorCustom,
                 data_type = "biomass_observed")
toc()

saveRDS(res_int_v5, "optimPar_params_t1.RDS")

```

```{r}
params_o1 <- params_t1

#put these new vals intospecies_params and go back to the top of this page to re-check the calibration 
species_params(params_o1)$erepro <- res_int_v5$par[1:19]
```

```{r}
species_params(params_o1)$mode <- c(0.5, #  mesozooplankton
                                 -2, # other krill
                                 1, # other macrozooplankton
                                 -2, # antarctic krill
                                 NA, # salps
                                 NA,   # mesopelagic fishes (balanced model biomass of meso fishes & ant. silverfish from McCormack et al. 2020)
                                 NA, # bathypelagic fishes
                                 NA, # shelf and coastal fishes (other fish from McCormack)
                                 NA, # flying birds
                                 NA,  # small divers
                                 NA, # squids
                                 NA, # toothfishes
                                 NA, # leopard seals
                                 NA,  # medium divers
                                 NA, # large divers #is now only elephant seals
                                 NA, # minke whales
                                 NA, # orca
                                 NA, # sperm whales
                                 NA # baleen whales
)
```


Let's change some of the parameters which make some of these groups less fishy!

Change the PPMR (beta) values for zooplankton groups, except for salps, so that PPMR 
```{r}
 

####### feeding kernels
params <- params_o1

#new predation kernel varies with pred size and species but is the same for all prey species, need to fill this in with values, according to Ryans' code
pred_kern <- array(0, dim=c(length(params@species_params$species),length(params@w),length(params@w_full)),dimnames=list(params@species_params$species,params@w,params@w_full))

#### change the feeding kernel
pred_kern[]<- params_o1@species_params$beta

mvals<- species_params(params_o1)$mode
#shift over microzoop
#mvals[1]<--2

for (i in 1:length(mvals)) {
  
  D.z <- 2*(3*params@w*1e12/(4*pi))^(1/3) # convert body mass g to ESD (um)
  betas =  (exp(0.02*log(D.z)^2 - mvals[i] + 1.832))^3
  
  if (!is.na(mvals[i])) pred_kern[i,,]<- betas
  
}
  pred_kern[]<-exp(-0.5*sweep(log(sweep(sweep(pred_kern,3,params@w_full,"*")^-1,2,params@w,"*")),1,params@species_params$sigma,"/")^2)
  pred_kern[] <- sweep(pred_kern,c(2,3),combn(params@w_full,1,function(x,w)x<params@w,w=params@w),"*") # find out the untrues and then multiply
  
```

```{r}
params_fk <- setPredKernel(params, pred_kernel = pred_kern)

sim_fk <- project(params_fk, t_max = 100)

plot(sim_fk)
```

```{r}
# saveRDS(params_fk, "params_fk.RDS")
```


Optim Round X

```{r}
vary_df <- data.frame("name" = c("erepro"),
                      "length" = c(19),
                      "lower" = c(0.000001), 
                      "upper" = c(0.999999),
                      "slot" = c("species_params"),
                      "unit" = c("linear"))

vary <- c(params_fk@species_params$erepro)
```


```{r}
tic()
res_int_v6 <- mizerHowTo::fastOptim(params = params,
                 vary = vary,
                 vary_df = vary_df,
                 errorFun = mizerHowTo::getErrorCustom,
                 data_type = "biomass_observed")
toc()

saveRDS(res_int_v6, "optimPar_params_t2.RDS")

```


```{r}
params_fk_optim <- params_fk

#put these new vals intospecies_params and go back to the top of this page to re-check the calibration 
species_params(params_fk_optim)$erepro <- res_int_v6$par[1:19]
```


```{r}

sim_fk_2 <- project(params_fk_optim, t_max = 100)

plot(sim_fk_2)
```


```{r}
params_fk_optim_tuned <- tuneParams(params_fk_optim)
```


```{r}
params_fk_optim_tuned@species_params$erepro
params_fk_optim_tuned@psi
```

An array (species x size) that holds the allocation to reproduction for each species at size, (w). Changed with setReproduction().

```{r}
maturity <- getMaturityProportion(params_fk_optim_tuned)["orca", ]
repro_prop <- getReproductionProportion(params_fk_optim_tuned)["orca", ]
df <- data.frame(Size = w(params_fk_optim_tuned), 
                 Reproduction = repro_prop, 
                 Maturity = maturity, 
                 Total = maturity * repro_prop)
dff <- melt(df, id.vars = "Size", 
            variable.name = "Type", 
            value.name = "Proportion")
library(ggplot2)
ggplot(dff) + geom_line(aes(x = Size, y = Proportion, colour = Type))

```


```{r}
# params_repro <- params_fk_optim_tuned 
# ####### psi function
#   
#   # Change allocation to reproduction = check for endotherms/determinate growers (should be 1 at wmat not winf)
#  psi_r=5
#  params_repro@psi[] <- unlist(tapply(params_repro@w,1:length(params_repro@w),function(wx,Winf,Wmat,n){
#    ((1 + (wx/(Wmat))^-psi_r)^-1) * (wx/Winf)^(1-n)},Winf=params_repro@species_params$w_inf,Wmat=params_repro@species_params$w_mat,n=params_repro@n))
# # # Set w < 1% of Wmat to 0
#  params_repro@psi[unlist(tapply(params_repro@w,1:length(params_repro@w),function(wx,Wmat)wx<(Wmat*0.01),Wmat=params_repro@species_params$w_mat))] <- 0
# # # Set all m > M to 1 # Check this is right...
#  params_repro@psi[unlist(tapply(params_repro@w,1:length(params_repro@w),function(wx,Winf)(wx/Winf)>1,Winf=params_repro@species_params$w_inf))] <- 1
```

[1] "mesozooplankton"          "other krill"              "other macrozooplankton"   "antarctic krill"          "salps"                   
 [6] "mesopelagic fishes"       "bathypelagic fishes"      "shelf and coastal fishes" "flying birds"             "small divers"            
[11] "squids"                   "toothfishes"              "leopard seals"            "medium divers"            "large divers"            
[16] "minke whales"             "orca"                     "sperm whales"             "baleen whales"  

# Step 1: Create a vector of species names for which you want to update mu_b
```{r}
species_to_update <- c("flying birds","small divers","leopard seals","medium divers","large divers","minke whales","orca","sperm whales","baleen whales")
```


add declining intraspecific juvenile mortality to background mortality for orca
```{r}
pm <- params_fk_optim_tuned
params_m <- params_fk_optim_tuned
# # for (i in 1: length(params@species_params$species)) params@mu_b[i,] <- params@mu_b[i,]  + 0.1*params@w^-0.25
#
# for (i in 1: length(params@species_params$species)) params@mu_b[i,] <- params@mu_b[i,]  + 0.1*params@w^-0.25
#

# params_m@mu_b[params_m@species_params$species == "orca"] <- pm@mu_b[pm@species_params$species == "orca"] + 0.1*pm@w[pm@species_params$species == "orca"]^-0.25

# params_m@mu_b[params_m@species_params$species == "baleen whales"] <- pm@mu_b[pm@species_params$species == "baleen whales"] + 0.1*pm@w[pm@species_params$species == "baleen whales"]^-0.25


# Step 2: Iterate over each species name and update the mu_b slot
for (species in species_to_update) {
  # Step 3: Update the mu_b slot using the formula
  params_m@mu_b[params_m@species_params$species == species] <- 
    pm@mu_b[pm@species_params$species == species] + 0.1 * pm@w[pm@species_params$species == species]^-0.25
}
```



```{r}
params_m <- setParams(params_m)
params_m <- steady(params_m)

params_m<-tuneParams(params_m)
```


```{r}
params_m@species_params$erepro
```


```{r}
sim_m1 <- project(params_m, t_max = 200)

plot(sim_m1)
plotlyBiomass(sim_m1)
```


Optim Round XX

```{r}
vary_df <- data.frame("name" = c("erepro"),
                      "length" = c(19),
                      "lower" = c(0.000001), 
                      "upper" = c(0.999999),
                      "slot" = c("species_params"),
                      "unit" = c("linear"))

vary <- c(params_m@species_params$erepro)
```


```{r}
tic()
res_int_v7 <- mizerHowTo::fastOptim(params = params_m,
                 vary = vary,
                 vary_df = vary_df,
                 errorFun = mizerHowTo::getErrorCustom,
                 data_type = "biomass_observed")
toc()

saveRDS(res_int_v7, "optimPar_params_t3.RDS")

```


```{r}
params_m_optim <- params_m

#put these new vals intospecies_params and go back to the top of this page to re-check the calibration 
species_params(params_m_optim)$erepro <- res_int_v7$par[1:19]
```




```{r}
sim_m1 <- project(params_m_optim, t_max = 200, effort = 0.2)

sim_m2 <- project(params_m_optim, t_max = 200, effort = 0.2, 
                         initial_n = sim_m1@n[200,,],
                         initial_n_pp = sim_m1@n_pp[200,])

sim_m3 <- project(params_m_optim, t_max = 400, effort = 0.2, 
                         initial_n = sim_m2@n[200,,],
                         initial_n_pp = sim_m2@n_pp[200,])

plot(sim_m3)
plotlyBiomass(sim_m3)
```


```{r}
# saveRDS(params_m_optim, "params_fk_mu.RDS")
```


```{r}
# params <- readRDS("params_fk.RDS")
params <- readRDS("params_latest_xx.RDS")
```



Updating biomass_observed, as I made a mistake previously asigning incorrect groups
```{r}
biomass_observed <- c(8.8, #  mesozooplankton
                      1.9, # other krill
                      10, # other macrozooplankton
                      4, # antarctic krill
                      0.652, # salps
                      1.2,   # mesopelagic fishes 
                      1.2, # bathypelagic fishes
                      2.732, # shelf and coastal fishes (other fish + Antarctic silverfish from McCormack)
                      0.003, # flying birds
                      0.016,  # small divers
                      0.15, # squids
                      0.75, # toothfishes
                      0.002, # leopard seals
                      0.265,  # medium divers
                      0.011, # large divers #is now only elephant seals
                      0.014, # minke whales
                      0.006, # orca
                      0.011, # sperm whales
                      0.127 # baleen whales
                      )
```


```{r}
species_params(params)$biomass_observed <- biomass_observed

species_params(params)$biomass_observed
```

```{r}
params <- tuneParams(params)

# saveRDS(params, "params_fk_v2.RDS")
```


```{r}
# params@species_params$ppmr_min
# params@species_params$ppmr_max
# params@species_params$pred_kernel_type
```



### Check species in params

```{r}
params@species_params$species
params@species_params
```


### Inspect yield observed
```{r}
params@species_params$yield_observed
params@gear_params$yield_observed

```

Add yield in tonnes per km2, same as g m2 and it is consistent with `biomass_observed` 

1.474341e+12 m^2 for model domain

1.474341e+12/1e+6 = 1474341 km^2

327610.762 kg of minke whale per year from 2010 - 2019

327.6/1474341 = 0.000222201 tonnes Minke whale yield per km2 from 2010 - 2019

3695.093 kg of baleen whale per year from 2010 - 2019

3.7/1474341 = 2.509596e-06 tonnes of baleen whale per km2 from 2010 - 2019

Values for toothfish compiled from CCAMLR data (https://fisheryreports.ccamlr.org/) and using areas from (https://gis.ccamlr.org/)

Value represents aggregated catch for both Patagonian and Antarctic Toothfish species, as well as estimated illegal (IUU) fishing.
The values by CCAMLR area (https://www.ccamlr.org/en/fisheries/toothfish-fisheries) does not appear to contain IUU in the catch.

'Catch (tonnes) - Toothfish - TOP - All Areas' has the annual breakdown of catch for toothfish, as well as bycatch, which provides the macrourus spp. (bathypelagic fish) catch

The value is a mean across the 3 divisions that are included in the model domain. 58.4.1, 58.4.2, and 58.4.3b
Include an estimated amount of bycatch for 'other species' bycatch values from CCAMLR, shelf & coastal fishes? mesopelagics? 


```{r}
yield_observed <- c(0, 0, 0, 0, 0, 0, 1.33363E-06, 3.84138E-07, 0, 0, 0, 4.36768E-05, 0, 0, 0, 0.000222201, 0, 0, 2.509596e-06) # to add a yield_observed column in species_params

species_params(params)$yield_observed <- yield_observed
```


```{r}
plotFMort(params)
```


Adjust catchability to include groups with added catch values
```{r}
# gear_params(params)$yield_observed <-  c(0, 0, 0, 0, 0, 0, 1.33363E-06, 3.84138E-07, 0, 0, 0, 4.36768E-05, 0, 0, 0, 0.000222201, 0, 0, 2.509596e-06)
# gear_params(params)$catchability <-  c(0, 0, 0, 0, 0, 0, 0.0000035, 0.0000025, 0, 0, 0, 0.0003, 0, 0, 0, 0.085, 0, 0, 0.0001)
```


### Glimpse full species params
```{r}
glimpse(params@species_params)
```


## Initial gear params

### FishMIP Effort

Select the main gear types and filter the region effort based on these
Bottom trawl = ice fish (shelf & coastal fish + toothfish) each gear can have more than one species (see gearParams())
Midwater/pelagic trawl = krill
Longline = toothfish

For whaling
Similar trend, but different efforts, then catchability could be scaled appropriately.
If the trends looks different, will need separate gears.

We need to start with a steady-state, but we're not starting in the period where there is a steady-state.
'Burn in' protocol, run steady using the first year of inputs (i.e., 1841 values and run for 20 years pre forcing using relative effort and initial n_pp). Get the params from steady and use them as starting values for therMizer

We're doing this initial spin up (using constant climate and fishing) to avoid model drift, which will need to be done prior to using 1841 values

```{r}
# gear_types <- data.frame(species = params@species_params$species,
#                gear = c(rep("longline",19),
#                         rep("bottom trawl", 19), 
#                         rep("pelagic trawl", 19), 
#                         rep("whaling", 19)),
#                # sel_func = c(rep("knife_edge",57),rep("sigmoid_length",19)),
#                # knife_edge_size = 2722 ,
#                # l50 = c(rep(NA,57), 1, 5, 5, 5, 10, 10, 10, 20, 20, 20, 20, 850, 600, 1500, 2200, 50), # need adjusting for 19 groups
#                # l25 = c(rep(NA,57), 0.8, 4, 4, 4, 8, 8, 8, 16, 16, 16, 16, 800, 500, 1400, 1500, 10), # need adjusting for 19 groups
#                # catchability = c(rep(0,7), 1,rep(0,8), rep(0,3),1,rep(0,3), 1,rep(0,8), 1, rep(0,15), rep(0,11), rep(1,4),0), # need adjusting for 19 groups
#                catchability = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0003, 0, 0, 0, 0, 0, 0, 0, # longline
#                                 0, 0, 0, 0, 0, 0, 0.0000035, 0.0000025, 0, 0, 0, 0.0003, 0, 0, 0, 0, 0, 0, 0, # bottom trawl
#                                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0003, 0, 0, 0, 0, 0, 0, 0, # pelagic trawl
#                                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.085, 0, 0, 0.0001), # whaling
#                initial_effort = 0.2)
# 
# params_gears <- params
# gear_params(params_gears) <- gear_types
# gear_params(params_gears)
```


```{r}
# params <- readRDS("params_fk_v2.RDS")
```


```{r}
# species_params(params)$temp_min <- temp_min
# species_params(params)$temp_max <- temp_max

```




## Check gear params

```{r}
# gear_params(params)
```






```{r}
# sim_fishing_v01 <- project(params, t_max = 200, effort = 0.2)
```


```{r}
# plot(sim_fishing_v01)
```

```{r}
# plotYieldGear(sim_fishing_v01)
```
```{r}
# params@species_params$species
```



```{r}
# gear_params(params)$catchability <-  c(rep(0,7), 0.1,rep(0,8), #longline (tf)
#                                        rep(0,3),0.1,rep(0,3), 0.1,rep(0,8), #bottom (tf + SCF)
#                                        0.1, rep(0,15), #pelagic (krill)
#                                        rep(0,11), 0.5,0,0,0.5, 0) #wahling (minke,baleen)
# 
# gear_params(params)$initial_effort <- 0.2
```




```{r}
# plotBiomassObservedVsModel(sim_fishing_v01)
# mizerHowTo::plotBiomassVsCatch(sim_fishing_v01)
```
```{r}
# plotBiomassVsSpecies(params)
```

```{r}
# saveRDS(params, "params_latest_biomass_09_Aug_2023.RDS")
```


## Skip Fishing Effort for now

```{r}
library(mizer)
library(therMizer)
library(tidyverse)
library(mizerExperimental)
library(mizerHowTo)
library(pbapply)
```


```{r}
new_params <- readRDS("params_latest_biomass_09_Aug_2023.RDS")
# new_params <- readRDS("params_fk_v2.RDS")
# new_params <- readRDS("params_fk.RDS") # Don't currently work with project() for therMizer, due to pred_kernel update

```

Check intial plankton abundance
```{r}
new_params@initial_n_pp
```

Check plankton abundance through time
```{r}
sim_initial <- project(new_params, t_max = 50)

sim_initial@n_pp
```



### Adding min and max temp for each group

Using sealifebase for all non-fish species/groups. In most cases, there are no listed Temperature values in the 'Environment' section, like there is for more data-rich species, e.g., cod

Instead, there are values at the bottom of the sealifebase pages in 'Estimates of some properties based on models' with 'Preferred temperature' estimates from the AquaMaps model-based approach (https://www.gbif.org/tool/81356/aquamaps-predicted-range-maps-for-aquatic-species)  

[1] "euphausiids":
Antarctic krill - (Preferred temperature (Ref. 115969): -1.5 - 1.6, mean 0.2 (based on 535 cells))
Crystal krill - (Preferred temperature (Ref. 115969): -1.8 - 1.1, mean -1.6 (based on 3588 cells)) 
Thysanoessa macrura - (Preferred temperature (Ref. 115969): -1.2 - 2.8, mean 0.2 (based on 24 cells). Not included due to small number of cells and low contribution to biomass in this model domain
[2]"mesopelagic fishes" - Electrona antarctica(nothing on fishbase)    
[3]"bathypelagic fishes" 
[X] "salps": -2 - 8.57 (Henschke & Pakhomov 2018: https://doi.org/10.1002/lno.11061) (also see: doi: 10.1515/popore−2015−0020 & https://doi.org/10.1002/aqc.3443)
[4]"shelf and coastal fishes":
Marbled rockcod (-1 - 5)
[5]"flying birds":
Southern giant petrel (Preferred temperature (Ref. 115969): 2.1 - 15.6, mean 10.1 (based on 533 cells));
Arctic tern (Sterna paradisaea) (Preferred temperature (Ref. 115969): 0.4 - 13.3, mean 6.8 (based on 2468 cells))
Thalassarche chrysostoma (Grey-headed petrel)  (Preferred temperature (Ref. 115969): 1.3 - 9.1, mean 5.2 (based on 263 cells))
South polar skua (Preferred temperature (Ref. 115969): 0.2 - 18.2, mean 6.4 (based on 1318 cells))
Diomedea exulans (Wandering albatross), (Preferred temperature (Ref. 115969): 0.5 - 12, mean 4.6 (based on 1528 cells)_
[6]"small divers" - no info for adelie, gentoo or crested penguins on sealifebase. Guess based on medium divers       
[7]"squids" - based on Psychroteuthis glacialis (sealifebase)                   
[8]"toothfishes" - no data on fishbase  
  - Patagonian toothfish: Preferred temperature (Ref. 123201): 1.8 - 8.8, mean 4.5 °C (based on 1109 cells).
  - Antarctic toothfish: Preferred temperature (Ref. 123201): -1.5 - 1.3, mean 0.2 °C (based on 411 cells).
[9]"leopard seals" - Preferred temperature (Ref. 115969): -1.9 - 1.4, mean -0.5 (based on 2109 cells).          
[10] "medium divers":
Crabeater Seals - (Preferred temperature (Ref. 115969): -0.4 - 1, mean 0.1 (based on 9397 cells))
Ross seals (Preferred temperature (Ref. 115969): -1.8 - 1.1, mean -1.5 (based on 2110 cells));
Weddell seals (Preferred temperature (Ref. 115969): -1.8 - 1, mean -1.6 (based on 6026 cells));
Hourglass dolphin (Preferred temperature (Ref. 115969): 0.1 - 2, mean 0.9 (based on 11222 cells)) # Not included in the biomass
King penguin (no data on sealifebase)
Emperor penguin (no data on sealifebase)
[11]"large divers" - Southern elephant seals only in this group now that Sperm whales are also seperated   
    - Southern elephant seals: Preferred temperature (Ref. 115969): 0.1 - 1.6, mean 0.8 (based on 16947 cells).      
[12]"minke whales"             
[13]"orca"                     
[14]"sperm whales"             
[15]"baleen whales" 

```{r}
temp_min <- c(-2, # mesozooplankton
                      -2, # other krill
                     -2, # other macrozooplankton
                     -2, # antarctic krill
                                       -2,   # salps
                                     -2, # mesopelagic fishes
                                     -2, # bathypelagic fishes
                                     -1, # "shelf and coastal fishes" 
                                     0.2, # "flying birds"
                                     -0.4, # "small divers"             
                                     -0.8, # "squids"                  
                                     -1.5, # "toothfishes"              
                                     -1.9, # "leopard seals"           
                                     -1.8, # "medium divers"            
                                     0.1, # "large divers"             
                                     0.2, # "minke whales"             
                                     0.3, # "orca"                     
                                     0.3, # "sperm whales"             
                                     0.2 # "baleen whales"
                                      ) 

temp_max <- c(2, # mesozooplankton
                      2, # other krill
                    2,  # other macrozooplankton
                  2, # antarctic krill
                    8.57, # salps
                                     5, # mesopelagic fishes
                                     5, # bathypelagic fishes
                                     5, # "shelf and coastal fishes" 
                                     18.2, # "flying birds"
                                     1, # "small divers"             
                                     1.1, # "squids"                  
                                     8.8, # "toothfishes"              
                                     1.4, # "leopard seals"           
                                     2, # "medium divers"            
                                     1.6, # "large divers"             
                                     7, # "minke whales"             
                                     13.1, # "orca"                     
                                     3.8, # "sperm whales"             
                                     10.2 # "baleen whales"
                                      ) 
```




```{r}
species_params(new_params)$temp_min <- temp_min
species_params(new_params)$temp_max <- temp_max

```


```{r}
# saveRDS(new_params, "therMizer_params_v1.RDS")
```


Raw data not pushed to github, the effort_array can be read in later if you bypass all this data prep.

# Effort
```{r}
# effort_FishMIP <- readRDS("FishMIP_fishing_data/effort_Prydz_Bay_1950_2010_resolution_v1.RDS")
# effort_IWC <- read.csv("FishMIP_fishing_data/IWC_effort.csv")[,-1]
# 
# glimpse(effort_FishMIP)
# glimpse(effort_IWC)
```

[1] "mesozooplankton"          "other krill"              "other macrozooplankton"   "antarctic krill"          "salps"                   
 [6] "mesopelagic fishes"       "bathypelagic fishes"      "shelf and coastal fishes" "flying birds"             "small divers"            
[11] "squids"                   "toothfishes"              "leopard seals"            "medium divers"            "large divers"            
[16] "minke whales"             "orca"                     "sperm whales"             "baleen whales"           

```{r}
# unique(effort_IWC$Species)
```
```{r tidy-IWC-effort}
# effort_IWC_tidy <- effort_IWC %>%
#   dplyr::mutate(species = Species) %>% 
#   dplyr::select(c(Year, species, effort_standard)) %>% 
#   dplyr::mutate(species = case_when(species == "Baleen" ~ "baleen whales",
#                              species == "Sperm" ~ "sperm whales",
#                              species == "Antarctic Minke" ~ "minke whales",
#                              species == "Killer" ~ "orca"
#                              ))
#   
# glimpse(effort_IWC_tidy)
# head(effort_IWC_tidy)
# summary(effort_IWC_tidy)
# 
# # saveRDS(effort_IWC_tidy, "FishMIP_fishing_data/effort_IWC_tidy.RDS")
```

```{r tidy-FishMIP-effort}
# effort_FishMIP_tidy <- effort_FishMIP %>%
#   dplyr::select(c(Year, species, effort_standard))
#   
# glimpse(effort_FishMIP_tidy)
# head(effort_FishMIP_tidy)
# summary(effort_FishMIP_tidy)
```

```{r}
# effort <- rbind(effort_IWC_tidy, effort_FishMIP_tidy)
# 
# effort <- effort %>% 
#   arrange(Year)
# 
# head(effort)
# glimpse(effort)
# summary(effort)
# 
# # write.csv(effort, "effort.csv")
```

```{r}
# # Create a 2-dimensional array
# summary_array <- array(NA, dim = c(length(unique(effort$Year)), length(unique(effort$species))))
# 
# # Loop through each combination of Year and Species
# for (i in 1:length(unique(effort$Year))) {
#   for (j in 1:length(unique(effort$species))) {
#     subset_data <- effort %>% 
#       filter(Year == unique(effort$Year)[i], species == unique(effort$species)[j])
#     if (nrow(subset_data) > 0) {
#       summary_array[i, j] <- subset_data$effort_standard
#     }
#   }
# }
# 
# # Set row and column names
# dimnames(summary_array) <- list(unique(effort$Year), unique(effort$species))
# 
# # Print the resulting summary array
# print(summary_array)
# 
# # write.csv(summary_array, "effort_array.csv")
```


```{r}
effort <- read.csv("effort_array.csv")

years <- effort[,1]

effort <- effort[,-1]
rownames(effort) <- years


# colnames(effort) <- rownames(gear_params(params))
colnames(effort) <- gear_params(params)$gear

head(effort)
glimpse(effort)
dim(effort)
```

Set up time steps
```{r}
time_steps <- 1961:2010
```

### temperature data

#input temperature data 
```{r}
# tos <- readRDS("FishMIP_Temperature_Forcing/tos_annual.rds")
# t500m <- readRDS("FishMIP_Temperature_Forcing/t500m_annual.rds")
# t1000m <- readRDS("FishMIP_Temperature_Forcing/t1000m_annual.rds")
# t1500m <- readRDS("FishMIP_Temperature_Forcing/t1500m_annual.rds")
# tob <- readRDS("FishMIP_Temperature_Forcing/tob_annual.rds")

tos <- readRDS("tos_annual.rds")
t500m <- readRDS("t500m_annual.rds")
t1000m <- readRDS("t1000m_annual.rds")
t1500m <- readRDS("t1500m_annual.rds")
tob <- readRDS("tob_annual.rds")
ocean_temp <- abind::abind(tos,t500m,t1000m, t1500m, tob, along = 2)
realm_names <- c("tos","t500m","t1000m", "t1500m", "tob")
colnames(ocean_temp) <- realm_names
rownames(ocean_temp) <- time_steps
```


### input npp data

```{r}
# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra.dat")
# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_w_full_164.dat")
# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_w_full_142.dat")
# isimip_plankton <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_annual.dat")
isimip_plankton <- read.table("GFDL_resource_spectra_annual.dat")


isimip_plankton <- as(isimip_plankton, "matrix")


rownames(isimip_plankton) <- time_steps
sizes <- new_params@w_full
colnames(isimip_plankton) <- sizes # signif(sizes, 6)


dim(isimip_plankton)
```


```{r}
head(isimip_plankton[1,]) #log values
isimip_plankton_comparison <- 10^isimip_plankton

head(isimip_plankton_comparison[1,])

head(isimip_plankton_comparison) # check how the plankton time series changes
```

Compare initial n_pp of sim using the pre-therMizer params with the isimip plankton
```{r}
initialNResource(sim_initial)
```
sim_initial: 8.29e-15     1.19e-14     1.71e-14     2.45e-14     3.51e-14     5.04e-14     7.23e-14     1.04e-13     1.49e-13     2.13e-13     3.06e-13     4.39e-13      6.3e-13     
             4.485542e+29 2.140866e+29 1.021796e+29 4.876842e+28 2.327626e+28 1.110933e+28 5.302277e+27 2.530679e+27 1.207846e+27 5.764826e+26 2.751445e+26 1.313214e+26  6.267725e+25
             
isimip:      8.3e-15      1.2e-14      1.7e-14      2.4e-14      3.5e-14        5e-14      7.2e-14        1e-13      1.5e-13      2.1e-13      3.1e-13      4.4e-13       6.3e-13       
             1.388271e+27 9.729357e+26 6.818582e+26 4.778636e+26 3.348990e+26 2.347058e+26 1.644878e+26 1.152772e+26 8.078924e+25 5.661916e+25 3.968015e+25 2.780886e+25  1.948916e+25  
             

So, the starting plankton abundance and the isimip plankton abundance are a couple orders magnitude out of line. We need to correct for this to introduce the anomaly but to scale it to the same intial n_pp, at least to get a steady state. We could then try to 'ween' the model onto the actual isimip n_pp, but may not be necessary


```{r}

n_pp_array <- array(NA, dim = c(length(time_steps), length(sizes)), dimnames = list(time = time_steps, w = sizes)) # setup an empty array for the corrected plankton

#
n_pp_array[1,] <- (isimip_plankton[1,] - colMeans(isimip_plankton[,])) + log10(new_params@initial_n_pp) #subtracting anomaly and adding back the mean
 for (t in seq(1,length(time_steps) - 1,1)) {
   n_pp_array[t + 1,] <- (isimip_plankton[t + 1,]  - colMeans(isimip_plankton[,])) + log10(new_params@initial_n_pp)
 }

 # n_pp_array <- ifelse(n_pp_array == -Inf, 0, n_pp_array)

# Introducing zeros which convert to -Inf

head(n_pp_array[1,]) #make it comparible
head(n_pp_array[50,])
head(log10(initialNResource(new_params)))
```
Above we changed the array that will be used to force the plankton dynamics through time.
We also need to adjust the initial n_pp
```{r}
params_updated_n_pp <- new_params

years_to_use<-as.character(2000:2010)

# years_to_use_v2<-as.character(2000-01-01:2010-12-01)

# head(initialNResource(new_params))


# initialNResource(params)[which(w_full(params) < 100)]<-10^colMeans(n_pp_array[years_to_use,])[which(w_full(params) < resource_params(params)$w_pp_cutoff)]
initialNResource(params_updated_n_pp)[which(w_full(params_updated_n_pp) < 100)]<- 10^colMeans(n_pp_array[years_to_use,])[which(w_full(params_updated_n_pp) < 100)]
#need to cut resource at 100g
initialNResource(params_updated_n_pp)[which(w_full(params_updated_n_pp) >=resource_params(params_updated_n_pp)$w_pp_cutoff)]<-0.0 # sets all above 100g to 0


head(initialNResource(new_params))
head(initialNResource(params_updated_n_pp))
```


```{r}
params_updated_n_pp <- steady(params_updated_n_pp)

plotSpectra(params_updated_n_pp)
```


#vertical_migration array set up----
```{r}
realm_names <- c("tos","t500m","t1000m", "t1500m", "tob")
colnames(ocean_temp) <- realm_names
species_names <- as.character(new_params@species_params$species)
sizes <- new_params@w

vertical_migration_array <- array(0, dim = (c(length(realm_names),
                                              length(species_names), length(sizes))),
                                  dimnames = list(realm = realm_names, sp = species_names,
                                                  w = signif(sizes, 3)))
```


```{r}
zone01 <- which(realm_names =="tos")
zone02 <- which(realm_names == "t500m")
zone03 <- which(realm_names =="t1000m")
zone04 <- which(realm_names == "t1500m")
zone05 <- which(realm_names == "tob")
```


```{r}
#mesozooplankton
MesZoo <- which(species_names=="mesozooplankton")
vertical_migration_array[zone01, MesZoo, ] <- 0.25
vertical_migration_array[zone02, MesZoo, ] <- 0.25
vertical_migration_array[zone03, MesZoo, ] <- 0.25
vertical_migration_array[zone04, MesZoo, ] <- 0.25
vertical_migration_array[zone05, MesZoo, ] <- 0
#other krill
Oth_krill <- which(species_names=="other krill")
vertical_migration_array[zone01, Oth_krill, ] <- 0.25
vertical_migration_array[zone02, Oth_krill, ] <- 0.25
vertical_migration_array[zone03, Oth_krill, ] <- 0.25
vertical_migration_array[zone04, Oth_krill, ] <- 0.25
vertical_migration_array[zone05, Oth_krill, ] <- 0
#other macrozooplankton
Oth_MacroZoo <- which(species_names=="other macrozooplankton")
vertical_migration_array[zone01, Oth_MacroZoo, ] <- 0.25
vertical_migration_array[zone02, Oth_MacroZoo, ] <- 0.25
vertical_migration_array[zone03, Oth_MacroZoo, ] <- 0.25
vertical_migration_array[zone04, Oth_MacroZoo, ] <- 0.25
vertical_migration_array[zone05, Oth_MacroZoo, ] <- 0
#antarctic krill
Ant_krill <- which(species_names=="antarctic krill")
vertical_migration_array[zone01, Ant_krill, ] <- 0.25
vertical_migration_array[zone02, Ant_krill, ] <- 0.25
vertical_migration_array[zone03, Ant_krill, ] <- 0.25
vertical_migration_array[zone04, Ant_krill, ] <- 0.25
vertical_migration_array[zone05, Ant_krill, ] <- 0
#salps
salps <- which(species_names=="salps")
vertical_migration_array[zone01, salps, ] <- 0.25
vertical_migration_array[zone02, salps, ] <- 0.25
vertical_migration_array[zone03, salps, ] <- 0.25
vertical_migration_array[zone04, salps, ] <- 0.25
vertical_migration_array[zone05, salps, ] <- 0
#mesopelagic fishes
MesoFish <- which(species_names=="mesopelagic fishes")
vertical_migration_array[zone01, MesoFish, ] <- 0.2
vertical_migration_array[zone02, MesoFish, ] <- 0.4
vertical_migration_array[zone03, MesoFish, ] <- 0.4
vertical_migration_array[zone04, MesoFish, ] <- 0
vertical_migration_array[zone05, MesoFish, ] <- 0
#bathypelagic fishes
BathyFish <- which(species_names=="bathypelagic fishes")
vertical_migration_array[zone01, BathyFish, ] <- 0
vertical_migration_array[zone02, BathyFish, ] <- 0.15
vertical_migration_array[zone03, BathyFish, ] <- 0.15
vertical_migration_array[zone04, BathyFish, ] <- 0.35
vertical_migration_array[zone05, BathyFish, ] <- 0.35
#shelf and coastal fishes
SCFish <- which(species_names=="shelf and coastal fishes")
vertical_migration_array[zone01, SCFish, ] <- 0.2
vertical_migration_array[zone02, SCFish, ] <- 0.2
vertical_migration_array[zone03, SCFish, ] <- 0.2
vertical_migration_array[zone04, SCFish, ] <- 0.2
vertical_migration_array[zone05, SCFish, ] <- 0.2
#flying birds
Birds <- which(species_names=="flying birds")
vertical_migration_array[zone01, Birds, ] <- 1
vertical_migration_array[zone02, Birds, ] <- 0
vertical_migration_array[zone03, Birds, ] <- 0
vertical_migration_array[zone04, Birds, ] <- 0
vertical_migration_array[zone05, Birds, ] <- 0
#small divers
Sm_divers <- which(species_names=="small divers")
vertical_migration_array[zone01, Sm_divers, ] <- 1
vertical_migration_array[zone02, Sm_divers, ] <- 0
vertical_migration_array[zone03, Sm_divers, ] <- 0
vertical_migration_array[zone04, Sm_divers, ] <- 0
vertical_migration_array[zone05, Sm_divers, ] <- 0
#squids
squids <- which(species_names=="squids")
vertical_migration_array[zone01, squids, ] <- 0.2
vertical_migration_array[zone02, squids, ] <- 0.2
vertical_migration_array[zone03, squids, ] <- 0.2
vertical_migration_array[zone04, squids, ] <- 0.2
vertical_migration_array[zone05, squids, ] <- 0.2
#toothfishes
toothfishes <- which(species_names=="toothfishes")
vertical_migration_array[zone01, toothfishes, ] <- 0.2
vertical_migration_array[zone02, toothfishes, ] <- 0.2
vertical_migration_array[zone03, toothfishes, ] <- 0.2
vertical_migration_array[zone04, toothfishes, ] <- 0.2
vertical_migration_array[zone05, toothfishes, ] <- 0.2
#leopard seals
seals <- which(species_names=="leopard seals")
vertical_migration_array[zone01, seals, ] <- 0.5
vertical_migration_array[zone02, seals, ] <- 0.5
vertical_migration_array[zone03, seals, ] <- 0
vertical_migration_array[zone04, seals, ] <- 0
vertical_migration_array[zone05, seals, ] <- 0
#medium divers
Md_divers <- which(species_names=="medium divers")
vertical_migration_array[zone01, Md_divers, ] <- 0.5
vertical_migration_array[zone02, Md_divers, ] <- 0.5
vertical_migration_array[zone03, Md_divers, ] <- 0
vertical_migration_array[zone04, Md_divers, ] <- 0
vertical_migration_array[zone05, Md_divers, ] <- 0
#large diver
Lrg_divers <- which(species_names=="large divers")
vertical_migration_array[zone01, Lrg_divers, ] <- 0.5
vertical_migration_array[zone02, Lrg_divers, ] <- 0.5
vertical_migration_array[zone03, Lrg_divers, ] <- 0
vertical_migration_array[zone04, Lrg_divers, ] <- 0
vertical_migration_array[zone05, Lrg_divers, ] <- 0
#minke whales
minke <- which(species_names=="minke whales")
vertical_migration_array[zone01, minke, ] <- 0.4
vertical_migration_array[zone02, minke, ] <- 0.4
vertical_migration_array[zone03, minke, ] <- 0.1
vertical_migration_array[zone04, minke, ] <- 0.1
vertical_migration_array[zone05, minke, ] <- 0
#orca
orca <- which(species_names=="orca")
vertical_migration_array[zone01, orca, ] <- 0.4
vertical_migration_array[zone02, orca, ] <- 0.4
vertical_migration_array[zone03, orca, ] <- 0.1
vertical_migration_array[zone04, orca, ] <- 0.1
vertical_migration_array[zone05, orca, ] <- 0
#sperm whales
sperm <- which(species_names=="sperm whales")
vertical_migration_array[zone01, sperm, ] <- 0.3
vertical_migration_array[zone02, sperm, ] <- 0.3
vertical_migration_array[zone03, sperm, ] <- 0.2
vertical_migration_array[zone04, sperm, ] <- 0.2
vertical_migration_array[zone05, sperm, ] <- 0
#baleen whales
Baleen <- which(species_names=="baleen whales")
vertical_migration_array[zone01, Baleen, ] <- 0.4
vertical_migration_array[zone02, Baleen, ] <- 0.4
vertical_migration_array[zone03, Baleen, ] <- 0.1
vertical_migration_array[zone04, Baleen, ] <- 0.1
vertical_migration_array[zone05, Baleen, ] <- 0
```


```{r}
paramsT <- upgradeTherParams(params_updated_n_pp,
                             ocean_temp_array = ocean_temp,
                             n_pp_array = n_pp_array, 
                             vertical_migration_array = vertical_migration_array,
                             aerobic_effect = TRUE, metabolism_effect = TRUE)
```



```{r}
initialNResource(paramsT)
```


```{r}
plotTherPerformance(paramsT)
plotTherScalar(paramsT)
plotSpectra(paramsT, total = T, power = 2)
plotGrowthCurves(paramsT, species_panel = T)
```

# Recalibrate parameters - THIS PART IS FOR THE STEADY STATE only

For this step, we re-estimate the reproduction/biomass parameters using time-averaged forcing data as near to the model reference period - 2010-19??

```{r}
sim <- project(paramsT, t_max = 50)
# plotBiomass(paramsT)
plotlyBiomass(sim)
plotSpectra(sim)
```

```{r}
head(sim@n_pp[1,])
head(sim@n_pp[2,])
head(sim@n_pp[3,])
head(sim@n_pp[50,])
```


```{r}
sim_T2 <- project(paramsT, t_max = 50, effort = 0.2, 
                         initial_n = sim@n[1,,],
                         initial_n_pp = sim@n_pp[1,])
```

```{r}
head(sim_T2@n_pp[1,])
head(sim_T2@n_pp[2,])
head(sim_T2@n_pp[3,])
head(sim_T2@n_pp[50,])
```


## Clear environment and start again with a reduced example.
Only one temperature and realm

```{r}
new_params <- readRDS("therMizer_params_v1.RDS")
```



# Simpler version with only 1 temperature realm to see if that's differnt. Is n_pp still acting the same way?

```{r}
ocean_temp <- readRDS("tos_annual.RDS")
ocean_temp <- as(ocean_temp, "matrix")

realm_names <- "tos"
time_steps <- 1961:2010
# ocean_temp <- read.csv("FishMIP_Temperature_Forcing/GFDL_Prydz_Bay_tos_mean.csv")[,-1]
# ocean_temp_all <- read.csv("FishMIP_Temperature_Forcing/GFDL_Prydz_Bay_temp_interpolate_mean.csv")[,-1]
# 
colnames(ocean_temp) <- realm_names
rownames(ocean_temp) <- time_steps
```

Tidy date variable so that it is numeric
```{r}
# ocean_temp_tidy <- ocean_temp %>%
#   mutate(date_tidy = parse_date_time(date, orders = "my"))


# ocean_temp_tidy <- ocean_temp %>%
#   mutate(colsplit(date, "_", names = c("month","year")),
#          month_numeric = match(month, c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))) %>%
#   mutate(date_comb = paste(year, month_numeric, sep="-")) %>% 
#   mutate(date_comb = as.Date.character(date_comb))

# glimpse(ocean_temp_tidy)
```

### input npp data

```{r}
isimip_plankton <- read.table("GFDL_resource_spectra_annual.dat")

isimip_plankton <- as(isimip_plankton, "matrix")

sizes <- new_params@w_full
length(sizes)

# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra.dat")
# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_w_full_164.dat")
# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_w_full_142.dat")
rownames(isimip_plankton) <- time_steps
colnames(isimip_plankton) <- sizes

head(isimip_plankton)
```



```{r}

n_pp_array <- array(NA, dim = c(length(time_steps), length(sizes)), dimnames = list(time = time_steps, w = sizes)) # setup an empty array for the corrected plankton

#
n_pp_array[1,] <- (isimip_plankton[1,] - colMeans(isimip_plankton[,])) + log10(new_params@initial_n_pp) #subtracting anomaly and adding back the mean
 for (t in seq(1,length(time_steps) - 1,1)) {
   n_pp_array[t + 1,] <- (isimip_plankton[t + 1,]  - colMeans(isimip_plankton[,])) + log10(new_params@initial_n_pp)
 }

 # n_pp_array <- ifelse(n_pp_array == -Inf, 0, n_pp_array)

# Introducing zeros which convert to -Inf

head(n_pp_array[1,]) #make it comparible
head(n_pp_array[50,])
head(log10(initialNResource(new_params)))
```



Above we changed the array that will be used to force the plankton dynamics through time.
We also need to adjust the initial n_pp
```{r}
params_updated_n_pp <- new_params

years_to_use<-as.character(2000:2010)

# years_to_use_v2<-as.character(2000-01-01:2010-12-01)

# head(initialNResource(new_params))


# initialNResource(params)[which(w_full(params) < 100)]<-10^colMeans(n_pp_array[years_to_use,])[which(w_full(params) < resource_params(params)$w_pp_cutoff)]
initialNResource(params_updated_n_pp)[which(w_full(params_updated_n_pp) < 100)]<- 10^colMeans(n_pp_array[years_to_use,])[which(w_full(params_updated_n_pp) < 100)]
#need to cut resource at 100g
initialNResource(params_updated_n_pp)[which(w_full(params_updated_n_pp) >=resource_params(params_updated_n_pp)$w_pp_cutoff)]<-0.0 # sets all above 100g to 0


head(initialNResource(new_params))
head(initialNResource(params_updated_n_pp))
```

### vertical_migration array setup

See Saunders et al. 2019 (https://doi.org/10.3389/fmars.2019.00530) for mesopelagic fish vertical distribution

```{r}
# # realm_names <- c("epi", "meso", "bathy", "demersal") # If using multiple realms 
# 
# realm_names <- c("tos")
# 
# # colnames(ocean_temp) <- realm_names
# species_names <- as.character(params@species_params$species)
# sizes <- params@w
# 
# vertical_migration_array <- array(1, dim = (c(length(realm_names),
#                                               length(species_names), length(sizes))),
#                                   dimnames = list(realm = realm_names, sp = species_names,
#                                                   w = signif(sizes, 3)))
```


## setup exposure array

```{r}
# exposure_array <- array(0, dim = (c(length(realm_names), length(species_names))), 
#                   dimnames = list(realm = realm_names, sp = species_names)) # realm x species
# 
# for (r in seq(1,length(realm_names),1)) {
#     for (s in seq(1,length(species_names),1)) {
#         if (any(vertical_migration_array[r,s,] > 0)) {
#             exposure_array[r,s] = 1
#         }
#     }
# }
```




### set up therMizer params

```{r}
paramsT_simple <- upgradeTherParams(params_updated_n_pp,
                             ocean_temp_array = ocean_temp,
                             n_pp_array = n_pp_array,
                             aerobic_effect = TRUE, metabolism_effect = TRUE)
```



```{r}
sim_simple <- project(paramsT_simple, t_max = 50)
# plotBiomass(paramsT)
plotlyBiomass(sim_simple)
plotSpectra(sim_simple)
```

```{r}
head(sim_simple@n_pp[1,])
head(sim_simple@n_pp[2,])
head(sim_simple@n_pp[3,])
head(sim_simple@n_pp[50,])
```

```{r}
n_pp_array_function <- function (params, n_pp_array, t, ...) {
    if (!floor(t) %in% as.numeric(dimnames(other_params(params)$ocean_temp)[[1]])) 
        t <- t%%as.numeric(dimnames(other_params(params)$ocean_temp)[[1]][dim(other_params(params)$ocean_temp)[[1]]]) + 
            as.numeric(dimnames(other_params(params)$ocean_temp)[[1]][1])
    w_cut_off <- params@resource_params$w_pp_cutoff
    index_vec <- as.numeric(dimnames(other_params(params)$ocean_temp)[[1]]) - 
        t
    index <- which(index_vec == max(index_vec[index_vec <= 0]))
    pkt <- 10^(n_pp_array[index, ])/params@dw_full
    pkt[which(as.numeric(names(pkt)) >= w_cut_off)] <- 0
    return(pkt)
}

n_pp_array_function(paramsT_simple, n_pp_array, 2)
n_pp_array_function(paramsT_simple, sim_initial@n_pp, 2)
n_pp_array_function(paramsT_simple, sim_simple@n_pp, 2)
```


```{r}
upgradeTherParams

upgradeTherParams_test <- function (params, temp_min = NULL, temp_max = NULL, ocean_temp_array = NULL, 
    n_pp_array = NULL, vertical_migration_array = NULL, exposure_array = NULL, 
    aerobic_effect = TRUE, metabolism_effect = TRUE)  {
  
    no_sp <- length(species_params(params)$species)
    if (is.null(temp_min)) {
        if (is.null(species_params(params)$temp_min)) 
            stop("You need to setup min temperature for your species.")
    }
    else if (length(temp_min) != no_sp) {
        stop("The length of temp_min is not the same as the number of species.")
    }
    else {
        species_params(params)$temp_min <- temp_min
    }
    if (is.null(temp_max)) {
        if (is.null(species_params(params)$temp_max)) 
            stop("You need to setup max temperature for your species.")
    }
    else if (length(temp_max) != no_sp) {
        stop("The length of temp_max is not the same as the number of species.")
    }
    else {
        species_params(params)$temp_max <- temp_max
    }
    params <- setEncounterPredScale(params)
    params <- setMetabTher(params)
    if (is.null(ocean_temp_array)) 
        stop("You need to specify a temperature array to do the projections.")
    if (is.vector(ocean_temp_array)) {
        if (is.null(names(ocean_temp_array))) {
            warning("ocean_temp_array has no dates. They are assumed to be successive years staring from 0.")
            names(ocean_temp_array) <- sprintf("%04d", seq(0, 
                length.out = length(ocean_temp_array)))
        }
        date_vec <- names(ocean_temp_array)
        parse_order <- ifelse(nchar(date_vec) <= 4, "%Y", ifelse(nchar(date_vec) == 
            7, "%Y-%m", "%Y-%m-%d"))
        if (parse_order[1] == "%Y" & any(nchar(date_vec) < 4)) 
            date_vec <- str_pad(date_vec, 4, pad = "0")
        date_vec <- parse_date_time(date_vec, orders = parse_order)
        date_vec <- as.numeric(year(date_vec)) + as.numeric(yday(date_vec) - 
            1)/as.numeric(ifelse(leap_year(date_vec), 366, 365))
        ocean_temp_array <- matrix(ocean_temp_array, nrow = length(ocean_temp_array), 
            ncol = dim(params@species_params)[1], byrow = F, 
            dimnames = list(time = date_vec, species = params@species_params$species))
    }
    else if (is.array(ocean_temp_array)) {
        date_vec <- dimnames(ocean_temp_array)[[1]]
        parse_order <- ifelse(nchar(date_vec) <= 4, "%Y", ifelse(nchar(date_vec) == 
            7, "%Y-%m", "%Y-%m-%d"))
        if (parse_order[1] == "%Y" & any(nchar(date_vec) < 4)) 
            date_vec <- str_pad(date_vec, 4, pad = "0")
        date_vec <- parse_date_time(date_vec, orders = parse_order)
        date_vec <- as.numeric(year(date_vec)) + as.numeric(yday(date_vec) - 
            1)/as.numeric(ifelse(leap_year(date_vec), 366, 365))
        dimnames(ocean_temp_array)[[1]] <- date_vec
    }
    else stop("The ocean_temp_array is of the wrong format")
    other_params(params)$ocean_temp <- ocean_temp_array
    if (!is.null(n_pp_array)) {
        if (!dim(ocean_temp_array)[1] == dim(n_pp_array)[1]) 
            stop("The time dimension of ocean_temp_array and n_pp_array must be equal.")
        if (!dim(n_pp_array)[2] == length(params@w_full)) 
            stop("The size dimension of the n_pp_array must be the same as w_full.")
        if (!identical(dimnames(n_pp_array)[[2]], params@w_full)) {
            warning("The dimnames of the second dimension of n_pp_array are not the same\n      as the ones in w_full. Since the dimension size is the same, the dimnames\n      have been replaced by w_full.")
            dimnames(n_pp_array)[[2]] <- params@w_full
        }
        if (!is.array(n_pp_array) && !is.matrix(n_pp_array)) 
            n_pp_array <- as.matrix(n_pp_array)
        params <- setResource(params, resource_dynamics = "plankton_forcing")
        dimnames(n_pp_array)[[1]] <- dimnames(ocean_temp_array)[[1]]
        other_params(params)$n_pp_array <- n_pp_array
    }
    if (!is.null(vertical_migration_array)) {
        params <- setVerticality(params, vertical_migration_array, 
            exposure_array)
    }
    else if (!is.null(exposure_array)) {
        vertical_fill <- 1/dim(exposure_array)[1]
        vertical_names <- dimnames(exposure_array)[[1]]
        vertical_dim <- c(dim(exposure_array), length(params@w))
        vertical_migration_array <- array(vertical_fill, dim = vertical_dim, 
            dimnames = list(realm = vertical_names, species = params@species_params$species, 
                w = params@w))
        message("exposure_array used to create vertical_migration_array.")
        params <- setVerticality(params, vertical_migration_array, 
            exposure_array)
    }
    else {
        if (is.null(dim(ocean_temp_array))) {
            vertical_fill <- rep(c(rep(c(1, rep(0, length(params@species_params$species))), 
                length(params@species_params$species) - 1), 1), 
                length(params@w))
            vertical_names <- params@species_params$species
            vertical_dim <- c(rep(length(params@species_params$species), 
                2), length(params@w))
            message("Assuming one realm per species to create vertical_migration_array.")
        }
        else if (!isTRUE(all.equal(dimnames(ocean_temp_array)[[2]], 
            params@species_params$species))) {
            vertical_fill <- 1/length(dimnames(ocean_temp_array)[[2]])
            vertical_names <- dimnames(ocean_temp_array)[[2]]
            vertical_dim <- c(dim(ocean_temp_array)[2], length(params@species_params$species), 
                length(params@w))
            message("Your realm names don't match your species names, so species are assumed to spend equal time in all realms.")
        }
        else {
            vertical_fill <- rep(c(rep(c(1, rep(0, length(params@species_params$species))), 
                length(params@species_params$species) - 1), 1), 
                length(params@w))
            vertical_names <- params@species_params$species
            vertical_dim <- c(rep(length(params@species_params$species), 
                2), length(params@w))
        }
        vertical_migration_array <- array(vertical_fill, dim = vertical_dim, 
            dimnames = list(realm = vertical_names, species = params@species_params$species, 
                w = params@w))
        params <- setVerticality(params, vertical_migration_array)
    }
    if (aerobic_effect) {
        params <- setRateFunction(params, "Encounter", "therMizerEncounter")
        params <- setRateFunction(params, "PredRate", "therMizerPredRate")
    }
    if (metabolism_effect) 
        params <- setRateFunction(params, "EReproAndGrowth", 
            "therMizerEReproAndGrowth")
    other_params(params)$t_idx = -as.numeric(dimnames(other_params(params)$ocean_temp)[[1]][1])
    return(params)
}
```


