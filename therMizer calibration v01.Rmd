---
title: "Calibrating a model within therMizer"
author: "Kieran Murphy"
date:  "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

Here I am attempting to incorporate fishing into a mizer params object and achieve a rough steady-state before beginning a full calibration in therMizer.

After the model is calibrated I will use the therMizer temperature comparison protocol and FishMIP protocol to run projections with fishing effort and warming.

## Libraries

```{r}
# remotes::install_github("sizespectrum/therMizer") # if needed
library(therMizer)
# remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
```


## Setup params

```{r}
params <- readRDS("params/params_optim_v04_w_pp_100.rds")
```


### Check species in params

```{r}
params@species_params$species
params@species_params
```


### Inspect yield observed
```{r}
params@species_params$yield_observed
```
There are only values for two of the whale groups, minke whales and baleen whales. 
These are the mean annual yield (tonnes km^2) for these two groups from 2000 - 2019

Details of calculations below:

Add yield in tonnes per km2, same as g m2 and it is consistent with `biomass_observed` 
1.474341e+12 m^2 for model domain
1.474341e+12/1e+6 = 1474341 km^2
507511 kg of minke whale per year from 2000 - 2019
507.5/1474341 = 0.0003442216 tonnes Minke whale yield per km2 from 2000 - 2019
15619.24 kg of baleen whale per year from 2000 - 2019
15.6/1474341 = 1.0581e-05 tonnes of baleen whale per km2 from 2000 - 2019

### Glimpse full species params
```{r}
glimpse(params@species_params)
```


## Initial gear params

### FishMIP Effort

Select the main gear types and filter the region effort based on these
Bottom trawl = ice fish (shelf & coastal fish + toothfish) each gear can have more than one species (see gearParams())
Midwater/pelagic trawl = krill
Longline = toothfish

For whaling
Similar trend, but different efforts, then catchability could be scaled appropriately.
If the trends looks different, will need separate gears.

We need to start with a steady-state, but we're not starting in the period where there is a steady-state.
'Burn in' protocol, run steady using the first year of inputs (i.e., 1841 values and run for 20 years pre forcing using relative effort and initial n_pp). Get the params from steady and use them as starting values for therMizer

We're doing this initial spin up (using constant climate and fishing) to avoid model drift, which will need to be done prior to using 1841 values

```{r}

gear_types <- data.frame(species = params@species_params$species,
               gear = c(rep("longline",16),
                        rep("bottom trawl", 16), 
                        rep("pelagic trawl", 16), 
                        rep("whaling", 16)),
               sel_func = c(rep("knife_edge",48),rep("sigmoid_length",16)),
               # knife_edge_size = 2722 ,
               l50 = c(rep(NA,48), 1, 5, 5, 5, 10, 10, 10, 20, 20, 20, 20, 850, 600, 1500, 2200, 50),
               l25 = c(rep(NA,48), 0.8, 4, 4, 4, 8, 8, 8, 16, 16, 16, 16, 800, 500, 1400, 1500, 10),
               catchability = c(rep(0,7), 1,rep(0,8), rep(0,3),1,rep(0,3), 1,rep(0,8), 1, rep(0,15), rep(0,11), rep(1,4),0),
               initial_effort = 1)

gear_params(params) <- gear_types

```

## Check gear params

```{r}
gear_params(params)
```


Adjust catchability to only select fishing on species with catch data
This is a only starting point
```{r}
# gear_params(params)$catchability <-  c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.49, 0, 0, 0.001, 0)
```


Mean annual catch (t km^2) from 2000 - 2019 

```{r}
params@species_params$yield_observed
```


```{r}
params <- upgradeParams(params)
```


```{r}
sim_fishing_v01 <- project(params, t_max = 200, effort = 0.2)
```


```{r}
plot(sim_fishing_v01)
```

```{r}
plotYieldGear(sim_fishing_v01)
```
```{r}
params@species_params$species
```


Adjust catchability to only select fishing on species with catch data
This is a only starting point
```{r}
gear_params(params)$catchability <-  c(rep(0,7), 1,rep(0,8), #longline
                                       rep(0,3),1,rep(0,3), 1,rep(0,8), #bottom
                                       1, rep(0,15), #pelagic
                                       rep(0,11), 1,0,0,1, 0) #wahling
```



```{r}
sim_fishing_v02 <- project(params, t_max = 200, effort = 0.2)
```

```{r}
plot(sim_fishing_v02)
```


```{r}
plotYieldGear(sim_fishing_v02)
```

Fishing on krill is driving it to extinction.
Try reducing the catchability for euphausiids

```{r}
gear_params(params)$catchability <-  c(rep(0,7), 1,rep(0,8), #longline
                                       rep(0,3),1,rep(0,3), 1,rep(0,8), #bottom
                                       0.5, rep(0,15), #pelagic
                                       rep(0,11), 1,0,0,1, 0) #wahling
```


```{r}
sim_fishing_v03 <- project(params, t_max = 200, effort = 0.2)
```


```{r}
plotYieldGear(sim_fishing_v03)
plot(sim_fishing_v03)
plotlyBiomass(sim_fishing_v03)
```

It was actually orcas and sperm whales going extinct. Might be because a large portion of their prey is now being fished (toothfish + shelf and coastal fishes)
Try reducing catchability for these groups

```{r}
gear_params(params)$catchability <-  c(rep(0,7), 0.1,rep(0,8), #longline (tf)
                                       rep(0,3),0.1,rep(0,3), 0.1,rep(0,8), #bottom (tf + SCF)
                                       0.1, rep(0,15), #pelagic (krill)
                                       rep(0,11), 0.5,0,0,0.5, 0) #wahling (minke,baleen)

gear_params(params)$initial_effort <- 0.2
```



```{r}
sim_fishing_v04 <- project(params, t_max = 1000, effort = 0.2)
```



```{r}
plotYieldGear(sim_fishing_v04)
plot(sim_fishing_v04)
plotlyBiomass(sim_fishing_v04)
```


```{r}
params@species_params$species
params@species_params$biomass_observed
```
```{r}
plotBiomassObservedVsModel(sim_fishing_v04)
```
```{r}
plotBiomassVsSpecies(params)
```
```{r}
params_v02 <- calibrateBiomass(params)
params_v02 <- steady(params_v02)
params_v02 <- matchBiomasses(params_v02)
params_v02 <- steady(params_v02)
```


```{r}
plotBiomassObservedVsModel(params_v02)
```


## Skip Fishing Effort for now

```{r}
# remotes::install_github("sizespectrum/therMizer") # if needed
library(therMizer)
```


```{r}
new_params <- readRDS("params/params_optim_v04_w_pp_100.rds")
```

### temperature data

```{r}
ocean_temp <- read.csv("FishMIP_Temperature_Forcing/GFDL_Prydz_Bay_tos_mean.csv")[,-1]
```

### input npp data

```{r}
# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra.dat")
n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_w_full_164.dat")

```


### vertical_migration array setup

```{r}
# realm_names <- c("epi", "meso", "bathy", "demersal") # If using multiple realms 

realm_names <- c("tos")

# colnames(ocean_temp) <- realm_names
species_names <- as.character(new_params@species_params$species)
sizes <- new_params@w

vertical_migration_array <- array(1, dim = (c(length(realm_names),
                                              length(species_names), length(sizes))),
                                  dimnames = list(realm = realm_names, sp = species_names,
                                                  w = signif(sizes, 3)))
```


## setup exposure array

```{r}
exposure_array <- array(0, dim = (c(length(realm_names), length(species_names))), 
                  dimnames = list(realm = realm_names, sp = species_names)) # realm x species

for (r in seq(1,length(realm_names),1)) {
    for (s in seq(1,length(species_names),1)) {
        if (any(vertical_migration_array[r,s,] > 0)) {
            exposure_array[r,s] = 1
        }
    }
}
```


### Adding min and max temp for each group

Using sealifebase for all non-fish species/groups. In most cases, there are no listed Temperature values in the 'Environment' section, like there is for more data-rich species, e.g., cod

Instead, there are values at the bottom of the sealifebase pages in 'Estimates of some properties based on models' with 'Preferred temperature' estimates from the AquaMaps model-based approach (https://www.gbif.org/tool/81356/aquamaps-predicted-range-maps-for-aquatic-species)  

[1] "euphausiids":
Antarctic krill - (Preferred temperature (Ref. 115969): -1.5 - 1.6, mean 0.2 (based on 535 cells))
Crystal krill - (Preferred temperature (Ref. 115969): -1.8 - 1.1, mean -1.6 (based on 3588 cells)) 
Thysanoessa macrura - (Preferred temperature (Ref. 115969): -1.2 - 2.8, mean 0.2 (based on 24 cells). Not included due to small number of cells and low contribution to biomass in this model domain
[2]"mesopelagic fishes" - Electrona antarctica(nothing on fishbase)    
[3]"bathypelagic fishes"      
[4]"shelf and coastal fishes":
Marbled rockcod (-1 - 5)
[5]"flying birds":
Southern giant petrel (Preferred temperature (Ref. 115969): 2.1 - 15.6, mean 10.1 (based on 533 cells));
Arctic tern (Sterna paradisaea) (Preferred temperature (Ref. 115969): 0.4 - 13.3, mean 6.8 (based on 2468 cells))
Thalassarche chrysostoma (Grey-headed petrel)  (Preferred temperature (Ref. 115969): 1.3 - 9.1, mean 5.2 (based on 263 cells))
South polar skua (Preferred temperature (Ref. 115969): 0.2 - 18.2, mean 6.4 (based on 1318 cells))
Diomedea exulans (Wandering albatross), (Preferred temperature (Ref. 115969): 0.5 - 12, mean 4.6 (based on 1528 cells)_
[6]"small divers" - no info for adelie, gentoo or crested penguins on sealifebase. Guess based on medium divers       
[7]"squids" - based on Psychroteuthis glacialis (sealifebase)                   
[8]"toothfishes" - no data on fishbase            
[9]"leopard seals" - Preferred temperature (Ref. 115969): -1.9 - 1.4, mean -0.5 (based on 2109 cells).          
[10] "medium divers":
Crabeater Seals - (Preferred temperature (Ref. 115969): -0.4 - 1, mean 0.1 (based on 9397 cells))
Ross seals (Preferred temperature (Ref. 115969): -1.8 - 1.1, mean -1.5 (based on 2110 cells));
Weddell seals (Preferred temperature (Ref. 115969): -1.8 - 1, mean -1.6 (based on 6026 cells));
Hourglass dolphin (Preferred temperature (Ref. 115969): 0.1 - 2, mean 0.9 (based on 11222 cells)) # Not included in the biomass
King penguin (no data on sealifebase)
Emperor penguin (no data on sealifebase)
[11]"large divers" - Southern elephant seals only in this group now that Sperm whales are also seperated         
[12]"minke whales"             
[13]"orca"                     
[14]"sperm whales"             
[15]"baleen whales" 

```{r}
temp_min <- c(-1.8, # euphausiids
                                     -2, # mesopelagic fishes
                                     -2, # bathypelagic fishes
                                     -1, # "shelf and coastal fishes" 
                                     0.2, # "flying birds"
                                     -0.4, # "small divers"             
                                     -0.8, # "squids"                  
                                     -2, # "toothfishes"              
                                     -1.9, # "leopard seals"           
                                     -0.4, # "medium divers"            
                                     0.1, # "large divers"             
                                     0.2, # "minke whales"             
                                     0.3, # "orca"                     
                                     0.3, # "sperm whales"             
                                     0.2,# "baleen whales"
                                      -2) # salps

temp_max <- c(1.6, # euphausiids
                                     5, # mesopelagic fishes
                                     5, # bathypelagic fishes
                                     5, # "shelf and coastal fishes" 
                                     18.2, # "flying birds"
                                     1, # "small divers"             
                                     1.1, # "squids"                  
                                     5, # "toothfishes"              
                                     1.4, # "leopard seals"           
                                     1, # "medium divers"            
                                     1.6, # "large divers"             
                                     7, # "minke whales"             
                                     13.1, # "orca"                     
                                     3.8, # "sperm whales"             
                                     10.2, # "baleen whales"
                                      5) # salps
```


```{r}
species_params(new_params)$temp_min <- temp_min
species_params(new_params)$temp_max <- temp_max

```


### set up therMizer params

```{r}
# paramsT <- upgradeTherParams(new_params,
#                              ocean_temp_array = ocean_temp,
#                              n_pp_array = n_pp_array, 
#                              vertical_migration_array = vertical_migration_array,
#                              aerobic_effect = TRUE, metabolism_effect = TRUE)
```

Error in upgradeTherParams(new_params, ocean_temp_array = ocean_temp_matrix, :
The size dimension of the n_pp_array must be the same as w_full.

```{r}
ocean_temp_matrix <- as.matrix(ocean_temp)
```



```{r}
paramsT <- upgradeTherParams(new_params,
                             ocean_temp_array = ocean_temp_matrix,
                             n_pp_array = n_pp_array, 
                             vertical_migration_array = vertical_migration_array,
                             exposure_array = exposure_array,
                             aerobic_effect = TRUE, metabolism_effect = TRUE)
```
Initial error as the length of n_pp_array was based on a different w_full

Error in upgradeTherParams(new_params, ocean_temp_array = ocean_temp_matrix, :
The size dimension of the n_pp_array must be the same as w_full.

But now I've updated the n_pp_array based on the same w_full length (164 size classes), but it's still flagging an error

Warning: The dimnames of the second dimension of n_pp_array are not the same
      as the ones in w_full. Since the dimension size is the same, the dimnames
      have been replaced by w_full.Error in dimnames(n_pp_array) <- `*vtmp*` : 
  length of 'dimnames' [1] not equal to array extent
  




```{r}
length(new_params@w_full)
dim(n_pp_array)
length(n_pp_array)

length(new_params@dw_full)
```


```{r}
paramsT <- upgradeTherParams(new_params,
                             ocean_temp_array = ocean_temp_matrix,
                             n_pp_array = n_pp_array, 
                             vertical_migration_array = vertical_migration_array,
                             aerobic_effect = TRUE, metabolism_effect = TRUE)
```

## Troubleshooting therMizer errors

To try and fix dimnames error, manually change the n_pp_array colnames with the same as params@w_full 
(i.e., one is Vi and the other is i)

## Calibration notes

Can add matchGrowth() into the matchBiomass()/matchCalibrate() framework

Establish criteria to constrain output
Biomass/catch within +- xx% etc
Diet - ontogenetic shifts for appropriate species etc.

check


