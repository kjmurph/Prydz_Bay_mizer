---
title: "Calibrating a model within therMizer"
author: "Kieran Murphy"
date:  "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

Here I am attempting to incorporate fishing into a mizer params object and achieve a rough steady-state before beginning a full calibration in therMizer.

After the model is calibrated I will use the therMizer temperature comparison protocol and FishMIP protocol to run projections with fishing effort and warming.

## Libraries

```{r}
# remotes::install_github("sizespectrum/therMizer") # if needed
library(therMizer)
# remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
# remotes::install_github("sizespectrum/mizerHowTo")
library(mizerHowTo)
```


## Setup params

```{r}
# params <- readRDS("params/params_optim_v04_w_pp_100.rds")
params <- readRDS("params_latest_xx.RDS") # antarctic krill group

plot(params)
plotFMort(params)
```

```{r}
params@species_params$species
```


Updating biomass_observed, as I made a mistake previously asigning incorrect groups
```{r}
biomass_observed <- c(8.8, #  mesozooplankton
                      1.9, # other krill
                      10, # other macrozooplankton
                      4, # antarctic krill
                      0.652, # salps
                      2.002,   # mesopelagic fishes (balanced model biomass of mesopelagic fishes and antarctic silverfish from McCormack et al. 2020)
                      2.002, # bathypelagic fishes
                      1.93, # shelf and coastal fishes (other fish from McCormack)
                      0.003, # flying birds
                      0.016,  # small divers
                      0.15, # squids
                      0.75, # toothfishes
                      0.002, # leopard seals
                      0.265,  # medium divers
                      0.011, # large divers #is now only elephant seals
                      0.014, # minke whales
                      0.006, # orca
                      0.011, # sperm whales
                      0.127 # baleen whales
                      )
```


```{r}
species_params(params)$biomass_observed <- biomass_observed

species_params(params)$biomass_observed
```

```{r}
params <- steady(params)
params <- matchBiomasses(params)
params <- steady(params)

```
```{r}
params_t1 <- tuneParams(params)
```


```{r}
params_t1@species_params$erepro
```

Optim Round 5

```{r}
vary_df <- data.frame("name" = c("erepro"),
                      "length" = c(19),
                      "lower" = c(0.000001), 
                      "upper" = c(0.999999),
                      "slot" = c("species_params"),
                      "unit" = c("linear"))

vary <- c(params_t1@species_params$erepro)
```


```{r}
tic()
res_int_v5 <- mizerHowTo::fastOptim(params = params,
                 vary = vary,
                 vary_df = vary_df,
                 errorFun = mizerHowTo::getErrorCustom,
                 data_type = "biomass_observed")
toc()

saveRDS(res_int_v5, "optimPar_params_t1.RDS")

```

```{r}
params_o1 <- params_t1

#put these new vals intospecies_params and go back to the top of this page to re-check the calibration 
species_params(params_o1)$erepro <- res_int_v5$par[1:19]
```

```{r}
species_params(params_o1)$mode <- c(0.5, #  mesozooplankton
                                 -2, # other krill
                                 1, # other macrozooplankton
                                 -2, # antarctic krill
                                 NA, # salps
                                 NA,   # mesopelagic fishes (balanced model biomass of meso fishes & ant. silverfish from McCormack et al. 2020)
                                 NA, # bathypelagic fishes
                                 NA, # shelf and coastal fishes (other fish from McCormack)
                                 NA, # flying birds
                                 NA,  # small divers
                                 NA, # squids
                                 NA, # toothfishes
                                 NA, # leopard seals
                                 NA,  # medium divers
                                 NA, # large divers #is now only elephant seals
                                 NA, # minke whales
                                 NA, # orca
                                 NA, # sperm whales
                                 NA # baleen whales
)
```


Let's change some of the parameters which make some of these groups less fishy!

Change the PPMR (beta) values for zooplankton groups, except for salps, so that PPMR 
```{r}
 

####### feeding kernels
params <- params_o1

#new predation kernel varies with pred size and species but is the same for all prey species, need to fill this in with values, according to Ryans' code
pred_kern <- array(0, dim=c(length(params@species_params$species),length(params@w),length(params@w_full)),dimnames=list(params@species_params$species,params@w,params@w_full))

#### change the feeding kernel
pred_kern[]<- params_o1@species_params$beta

mvals<- species_params(params_o1)$mode
#shift over microzoop
#mvals[1]<--2

for (i in 1:length(mvals)) {
  
  D.z <- 2*(3*params@w*1e12/(4*pi))^(1/3) # convert body mass g to ESD (um)
  betas =  (exp(0.02*log(D.z)^2 - mvals[i] + 1.832))^3
  
  if (!is.na(mvals[i])) pred_kern[i,,]<- betas
  
}
  pred_kern[]<-exp(-0.5*sweep(log(sweep(sweep(pred_kern,3,params@w_full,"*")^-1,2,params@w,"*")),1,params@species_params$sigma,"/")^2)
  pred_kern[] <- sweep(pred_kern,c(2,3),combn(params@w_full,1,function(x,w)x<params@w,w=params@w),"*") # find out the untrues and then multiply
  
```

```{r}
params_fk <- setPredKernel(params, pred_kernel = pred_kern)

sim_fk <- project(params_fk, t_max = 100)

plot(sim_fk)
```

```{r}
# saveRDS(params_fk, "params_fk.RDS")
```


Optim Round X

```{r}
vary_df <- data.frame("name" = c("erepro"),
                      "length" = c(19),
                      "lower" = c(0.000001), 
                      "upper" = c(0.999999),
                      "slot" = c("species_params"),
                      "unit" = c("linear"))

vary <- c(params_fk@species_params$erepro)
```


```{r}
tic()
res_int_v6 <- mizerHowTo::fastOptim(params = params,
                 vary = vary,
                 vary_df = vary_df,
                 errorFun = mizerHowTo::getErrorCustom,
                 data_type = "biomass_observed")
toc()

saveRDS(res_int_v6, "optimPar_params_t2.RDS")

```


```{r}
params_fk_optim <- params_fk

#put these new vals intospecies_params and go back to the top of this page to re-check the calibration 
species_params(params_fk_optim)$erepro <- res_int_v6$par[1:19]
```


```{r}

sim_fk_2 <- project(params_fk_optim, t_max = 100)

plot(sim_fk_2)
```


```{r}
params_fk_optim_tuned <- tuneParams(params_fk_optim)
```


```{r}
params_fk_optim_tuned@species_params$erepro
params_fk_optim_tuned@psi
```

An array (species x size) that holds the allocation to reproduction for each species at size, (w). Changed with setReproduction().

```{r}
maturity <- getMaturityProportion(params_fk_optim_tuned)["orca", ]
repro_prop <- getReproductionProportion(params_fk_optim_tuned)["orca", ]
df <- data.frame(Size = w(params_fk_optim_tuned), 
                 Reproduction = repro_prop, 
                 Maturity = maturity, 
                 Total = maturity * repro_prop)
dff <- melt(df, id.vars = "Size", 
            variable.name = "Type", 
            value.name = "Proportion")
library(ggplot2)
ggplot(dff) + geom_line(aes(x = Size, y = Proportion, colour = Type))

```


```{r}
# params_repro <- params_fk_optim_tuned 
# ####### psi function
#   
#   # Change allocation to reproduction = check for endotherms/determinate growers (should be 1 at wmat not winf)
#  psi_r=5
#  params_repro@psi[] <- unlist(tapply(params_repro@w,1:length(params_repro@w),function(wx,Winf,Wmat,n){
#    ((1 + (wx/(Wmat))^-psi_r)^-1) * (wx/Winf)^(1-n)},Winf=params_repro@species_params$w_inf,Wmat=params_repro@species_params$w_mat,n=params_repro@n))
# # # Set w < 1% of Wmat to 0
#  params_repro@psi[unlist(tapply(params_repro@w,1:length(params_repro@w),function(wx,Wmat)wx<(Wmat*0.01),Wmat=params_repro@species_params$w_mat))] <- 0
# # # Set all m > M to 1 # Check this is right...
#  params_repro@psi[unlist(tapply(params_repro@w,1:length(params_repro@w),function(wx,Winf)(wx/Winf)>1,Winf=params_repro@species_params$w_inf))] <- 1
```

[1] "mesozooplankton"          "other krill"              "other macrozooplankton"   "antarctic krill"          "salps"                   
 [6] "mesopelagic fishes"       "bathypelagic fishes"      "shelf and coastal fishes" "flying birds"             "small divers"            
[11] "squids"                   "toothfishes"              "leopard seals"            "medium divers"            "large divers"            
[16] "minke whales"             "orca"                     "sperm whales"             "baleen whales"  

# Step 1: Create a vector of species names for which you want to update mu_b
```{r}
species_to_update <- c("flying birds","small divers","leopard seals","medium divers","large divers","minke whales","orca","sperm whales","baleen whales")
```


add declining intraspecific juvenile mortality to background mortality for orca
```{r}
pm <- params_fk_optim_tuned
params_m <- params_fk_optim_tuned
# # for (i in 1: length(params@species_params$species)) params@mu_b[i,] <- params@mu_b[i,]  + 0.1*params@w^-0.25
#
# for (i in 1: length(params@species_params$species)) params@mu_b[i,] <- params@mu_b[i,]  + 0.1*params@w^-0.25
#

# params_m@mu_b[params_m@species_params$species == "orca"] <- pm@mu_b[pm@species_params$species == "orca"] + 0.1*pm@w[pm@species_params$species == "orca"]^-0.25

# params_m@mu_b[params_m@species_params$species == "baleen whales"] <- pm@mu_b[pm@species_params$species == "baleen whales"] + 0.1*pm@w[pm@species_params$species == "baleen whales"]^-0.25


# Step 2: Iterate over each species name and update the mu_b slot
for (species in species_to_update) {
  # Step 3: Update the mu_b slot using the formula
  params_m@mu_b[params_m@species_params$species == species] <- 
    pm@mu_b[pm@species_params$species == species] + 0.1 * pm@w[pm@species_params$species == species]^-0.25
}
```



```{r}
params_m <- setParams(params_m)
params_m <- steady(params_m)

params_m<-tuneParams(params_m)
```


```{r}
params_m@species_params$erepro
```


```{r}
sim_m1 <- project(params_m, t_max = 200)

plot(sim_m1)
plotlyBiomass(sim_m1)
```


Optim Round XX

```{r}
vary_df <- data.frame("name" = c("erepro"),
                      "length" = c(19),
                      "lower" = c(0.000001), 
                      "upper" = c(0.999999),
                      "slot" = c("species_params"),
                      "unit" = c("linear"))

vary <- c(params_m@species_params$erepro)
```


```{r}
tic()
res_int_v7 <- mizerHowTo::fastOptim(params = params_m,
                 vary = vary,
                 vary_df = vary_df,
                 errorFun = mizerHowTo::getErrorCustom,
                 data_type = "biomass_observed")
toc()

saveRDS(res_int_v7, "optimPar_params_t3.RDS")

```


```{r}
params_m_optim <- params_m

#put these new vals intospecies_params and go back to the top of this page to re-check the calibration 
species_params(params_m_optim)$erepro <- res_int_v7$par[1:19]
```




```{r}
sim_m1 <- project(params_m_optim, t_max = 200, effort = 0.2)

sim_m2 <- project(params_m_optim, t_max = 200, effort = 0.2, 
                         initial_n = sim_m1@n[200,,],
                         initial_n_pp = sim_m1@n_pp[200,])

sim_m3 <- project(params_m_optim, t_max = 400, effort = 0.2, 
                         initial_n = sim_m2@n[200,,],
                         initial_n_pp = sim_m2@n_pp[200,])

plot(sim_m3)
plotlyBiomass(sim_m3)
```


```{r}
# saveRDS(params_m_optim, "params_fk_mu.RDS")
```


### Check species in params

```{r}
params@species_params$species
params@species_params
```


### Inspect yield observed
```{r}
params@species_params$yield_observed
params@gear_params$yield_observed

```

Add yield in tonnes per km2, same as g m2 and it is consistent with `biomass_observed` 

1.474341e+12 m^2 for model domain

1.474341e+12/1e+6 = 1474341 km^2

327610.762 kg of minke whale per year from 2010 - 2019

327.6/1474341 = 0.000222201 tonnes Minke whale yield per km2 from 2010 - 2019

3695.093 kg of baleen whale per year from 2010 - 2019

3.7/1474341 = 2.509596e-06 tonnes of baleen whale per km2 from 2010 - 2019

Values for toothfish compiled from CCAMLR data (https://fisheryreports.ccamlr.org/) and using areas from (https://gis.ccamlr.org/)

Value represents aggregated catch for both Patagonian and Antarctic Toothfish species, as well as estimated illegal (IUU) fishing.
The values by CCAMLR area (https://www.ccamlr.org/en/fisheries/toothfish-fisheries) does not appear to contain IUU in the catch.

'Catch (tonnes) - Toothfish - TOP - All Areas' has the annual breakdown of catch for toothfish, as well as bycatch, which provides the macrourus spp. (bathypelagic fish) catch

The value is a mean across the 3 divisions that are included in the model domain. 58.4.1, 58.4.2, and 58.4.3b
Include an estimated amount of bycatch for 'other species' bycatch values from CCAMLR, shelf & coastal fishes? mesopelagics? 


```{r}
yield_observed <- c(0, 0, 0, 0, 0, 0, 1.33363E-06, 3.84138E-07, 0, 0, 0, 4.36768E-05, 0, 0, 0, 0.000222201, 0, 0, 2.509596e-06) # to add a yield_observed column in species_params

species_params(params)$yield_observed <- yield_observed
```


```{r}
plotFMort(params)
```


Adjust catchability to include groups with added catch values
```{r}
# gear_params(params)$yield_observed <-  c(0, 0, 0, 0, 0, 0, 1.33363E-06, 3.84138E-07, 0, 0, 0, 4.36768E-05, 0, 0, 0, 0.000222201, 0, 0, 2.509596e-06)
# gear_params(params)$catchability <-  c(0, 0, 0, 0, 0, 0, 0.0000035, 0.0000025, 0, 0, 0, 0.0003, 0, 0, 0, 0.085, 0, 0, 0.0001)
```


### Glimpse full species params
```{r}
glimpse(params@species_params)
```


## Initial gear params

### FishMIP Effort

Select the main gear types and filter the region effort based on these
Bottom trawl = ice fish (shelf & coastal fish + toothfish) each gear can have more than one species (see gearParams())
Midwater/pelagic trawl = krill
Longline = toothfish

For whaling
Similar trend, but different efforts, then catchability could be scaled appropriately.
If the trends looks different, will need separate gears.

We need to start with a steady-state, but we're not starting in the period where there is a steady-state.
'Burn in' protocol, run steady using the first year of inputs (i.e., 1841 values and run for 20 years pre forcing using relative effort and initial n_pp). Get the params from steady and use them as starting values for therMizer

We're doing this initial spin up (using constant climate and fishing) to avoid model drift, which will need to be done prior to using 1841 values

```{r}

gear_types <- data.frame(species = params@species_params$species,
               gear = c(rep("longline",19),
                        rep("bottom trawl", 19), 
                        rep("pelagic trawl", 19), 
                        rep("whaling", 19)),
               # sel_func = c(rep("knife_edge",57),rep("sigmoid_length",19)),
               # knife_edge_size = 2722 ,
               # l50 = c(rep(NA,57), 1, 5, 5, 5, 10, 10, 10, 20, 20, 20, 20, 850, 600, 1500, 2200, 50), # need adjusting for 19 groups
               # l25 = c(rep(NA,57), 0.8, 4, 4, 4, 8, 8, 8, 16, 16, 16, 16, 800, 500, 1400, 1500, 10), # need adjusting for 19 groups
               # catchability = c(rep(0,7), 1,rep(0,8), rep(0,3),1,rep(0,3), 1,rep(0,8), 1, rep(0,15), rep(0,11), rep(1,4),0), # need adjusting for 19 groups
               catchability = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0003, 0, 0, 0, 0, 0, 0, 0, # longline
                                0, 0, 0, 0, 0, 0, 0.0000035, 0.0000025, 0, 0, 0, 0.0003, 0, 0, 0, 0, 0, 0, 0, # bottom trawl
                                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0003, 0, 0, 0, 0, 0, 0, 0, # pelagic trawl
                                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.085, 0, 0, 0.0001), # whaling
               initial_effort = 0.2)

params_gears <- params
gear_params(params_gears) <- gear_types
gear_params(params_gears)

```


### Adding min and max temp for each group

Using sealifebase for all non-fish species/groups. In most cases, there are no listed Temperature values in the 'Environment' section, like there is for more data-rich species, e.g., cod

Instead, there are values at the bottom of the sealifebase pages in 'Estimates of some properties based on models' with 'Preferred temperature' estimates from the AquaMaps model-based approach (https://www.gbif.org/tool/81356/aquamaps-predicted-range-maps-for-aquatic-species)  

[1] "euphausiids":
Antarctic krill - (Preferred temperature (Ref. 115969): -1.5 - 1.6, mean 0.2 (based on 535 cells))
Crystal krill - (Preferred temperature (Ref. 115969): -1.8 - 1.1, mean -1.6 (based on 3588 cells)) 
Thysanoessa macrura - (Preferred temperature (Ref. 115969): -1.2 - 2.8, mean 0.2 (based on 24 cells). Not included due to small number of cells and low contribution to biomass in this model domain
[2]"mesopelagic fishes" - Electrona antarctica(nothing on fishbase)    
[3]"bathypelagic fishes" 
[X] "salps": -2 - 8.57 (Henschke & Pakhomov 2018: https://doi.org/10.1002/lno.11061) (also see: doi: 10.1515/popore−2015−0020 & https://doi.org/10.1002/aqc.3443)
[4]"shelf and coastal fishes":
Marbled rockcod (-1 - 5)
[5]"flying birds":
Southern giant petrel (Preferred temperature (Ref. 115969): 2.1 - 15.6, mean 10.1 (based on 533 cells));
Arctic tern (Sterna paradisaea) (Preferred temperature (Ref. 115969): 0.4 - 13.3, mean 6.8 (based on 2468 cells))
Thalassarche chrysostoma (Grey-headed petrel)  (Preferred temperature (Ref. 115969): 1.3 - 9.1, mean 5.2 (based on 263 cells))
South polar skua (Preferred temperature (Ref. 115969): 0.2 - 18.2, mean 6.4 (based on 1318 cells))
Diomedea exulans (Wandering albatross), (Preferred temperature (Ref. 115969): 0.5 - 12, mean 4.6 (based on 1528 cells)_
[6]"small divers" - no info for adelie, gentoo or crested penguins on sealifebase. Guess based on medium divers       
[7]"squids" - based on Psychroteuthis glacialis (sealifebase)                   
[8]"toothfishes" - no data on fishbase  
  - Patagonian toothfish: Preferred temperature (Ref. 123201): 1.8 - 8.8, mean 4.5 °C (based on 1109 cells).
  - Antarctic toothfish: Preferred temperature (Ref. 123201): -1.5 - 1.3, mean 0.2 °C (based on 411 cells).
[9]"leopard seals" - Preferred temperature (Ref. 115969): -1.9 - 1.4, mean -0.5 (based on 2109 cells).          
[10] "medium divers":
Crabeater Seals - (Preferred temperature (Ref. 115969): -0.4 - 1, mean 0.1 (based on 9397 cells))
Ross seals (Preferred temperature (Ref. 115969): -1.8 - 1.1, mean -1.5 (based on 2110 cells));
Weddell seals (Preferred temperature (Ref. 115969): -1.8 - 1, mean -1.6 (based on 6026 cells));
Hourglass dolphin (Preferred temperature (Ref. 115969): 0.1 - 2, mean 0.9 (based on 11222 cells)) # Not included in the biomass
King penguin (no data on sealifebase)
Emperor penguin (no data on sealifebase)
[11]"large divers" - Southern elephant seals only in this group now that Sperm whales are also seperated   
    - Southern elephant seals: Preferred temperature (Ref. 115969): 0.1 - 1.6, mean 0.8 (based on 16947 cells).      
[12]"minke whales"             
[13]"orca"                     
[14]"sperm whales"             
[15]"baleen whales" 

```{r}
temp_min <- c(-2, # mesozooplankton
                      -2, # other krill
                     -2, # other macrozooplankton
                     -2, # antarctic krill
                                       -2,   # salps
                                     -2, # mesopelagic fishes
                                     -2, # bathypelagic fishes
                                     -1, # "shelf and coastal fishes" 
                                     0.2, # "flying birds"
                                     -0.4, # "small divers"             
                                     -0.8, # "squids"                  
                                     -1.5, # "toothfishes"              
                                     -1.9, # "leopard seals"           
                                     -1.8, # "medium divers"            
                                     0.1, # "large divers"             
                                     0.2, # "minke whales"             
                                     0.3, # "orca"                     
                                     0.3, # "sperm whales"             
                                     0.2 # "baleen whales"
                                      ) 

temp_max <- c(2, # mesozooplankton
                      2, # other krill
                    2,  # other macrozooplankton
                  2, # antarctic krill
                    8.57, # salps
                                     5, # mesopelagic fishes
                                     5, # bathypelagic fishes
                                     5, # "shelf and coastal fishes" 
                                     18.2, # "flying birds"
                                     1, # "small divers"             
                                     1.1, # "squids"                  
                                     8.8, # "toothfishes"              
                                     1.4, # "leopard seals"           
                                     2, # "medium divers"            
                                     1.6, # "large divers"             
                                     7, # "minke whales"             
                                     13.1, # "orca"                     
                                     3.8, # "sperm whales"             
                                     10.2 # "baleen whales"
                                      ) 
```


```{r}
species_params(params)$temp_min <- temp_min
species_params(params)$temp_max <- temp_max

```




## Check gear params

```{r}
gear_params(params)
```




```{r}
ther_params <- upgradeTherParams(params)
```


```{r}
sim_fishing_v01 <- project(params, t_max = 200, effort = 0.2)
```


```{r}
plot(sim_fishing_v01)
```

```{r}
plotYieldGear(sim_fishing_v01)
```
```{r}
params@species_params$species
```


Adjust catchability to only select fishing on species with catch data
This is a only starting point
```{r}
gear_params(params)$catchability <-  c(rep(0,7), 1,rep(0,8), #longline
                                       rep(0,3),1,rep(0,3), 1,rep(0,8), #bottom
                                       1, rep(0,15), #pelagic
                                       rep(0,11), 1,0,0,1, 0) #wahling
```



```{r}
sim_fishing_v02 <- project(params, t_max = 200, effort = 0.2)
```

```{r}
plot(sim_fishing_v02)
```


```{r}
plotYieldGear(sim_fishing_v02)
```

Fishing on krill is driving it to extinction.
Try reducing the catchability for euphausiids

```{r}
gear_params(params)$catchability <-  c(rep(0,7), 1,rep(0,8), #longline
                                       rep(0,3),1,rep(0,3), 1,rep(0,8), #bottom
                                       0.5, rep(0,15), #pelagic
                                       rep(0,11), 1,0,0,1, 0) #wahling
```


```{r}
sim_fishing_v03 <- project(params, t_max = 200, effort = 0.2)
```


```{r}
plotYieldGear(sim_fishing_v03)
plot(sim_fishing_v03)
plotlyBiomass(sim_fishing_v03)
```

It was actually orcas and sperm whales going extinct. Might be because a large portion of their prey is now being fished (toothfish + shelf and coastal fishes)
Try reducing catchability for these groups

```{r}
gear_params(params)$catchability <-  c(rep(0,7), 0.1,rep(0,8), #longline (tf)
                                       rep(0,3),0.1,rep(0,3), 0.1,rep(0,8), #bottom (tf + SCF)
                                       0.1, rep(0,15), #pelagic (krill)
                                       rep(0,11), 0.5,0,0,0.5, 0) #wahling (minke,baleen)

gear_params(params)$initial_effort <- 0.2
```



```{r}
sim_fishing_v04 <- project(params, t_max = 1000, effort = 0.2)
```



```{r}
plotYieldGear(sim_fishing_v04)
plot(sim_fishing_v04)
plotlyBiomass(sim_fishing_v04)
```


```{r}
params@species_params$species
params@species_params$biomass_observed
```
```{r}
plotBiomassObservedVsModel(sim_fishing_v04)
```
```{r}
plotBiomassVsSpecies(params)
```
```{r}
params_v02 <- calibrateBiomass(params)
params_v02 <- steady(params_v02)
params_v02 <- matchBiomasses(params_v02)
params_v02 <- steady(params_v02)
```


```{r}
plotBiomassObservedVsModel(params_v02)
```


## Skip Fishing Effort for now

```{r}
# remotes::install_github("sizespectrum/therMizer") # if needed
library(therMizer)
```


```{r}
# new_params <- readRDS("params/params_optim_v04_w_pp_100.rds")
```

### temperature data

```{r}
ocean_temp <- read.csv("FishMIP_Temperature_Forcing/GFDL_Prydz_Bay_tos_mean.csv")[,-1]
glimpse(ocean_temp)
head(ocean_temp, 24)
```
Tidy date variable so that it is numeric
```{r}
ocean_temp_tidy <- ocean_temp %>%
  mutate(colsplit(date, "_", names = c("month","year")),
         month_numeric = match(month, c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))) %>% 
  mutate(date_comb = paste(ocean_temp_tidy$month_numeric ,ocean_temp_tidy$year, sep="-"))
        
  # mutate(date_month = lubridate::month(month))

glimpse(ocean_temp_tidy)
```


### input npp data

```{r}
# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra.dat")
# n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_w_full_164.dat")
n_pp_array <- read.table("FishMIP_Plankton_Forcing/GFDL_resource_spectra_w_full_142.dat")

head(n_pp_array)
```


### vertical_migration array setup

See Saunders et al. 2019 (https://doi.org/10.3389/fmars.2019.00530) for mesopelagic fish vertical distribution

```{r}
# realm_names <- c("epi", "meso", "bathy", "demersal") # If using multiple realms 

realm_names <- c("tos")

# colnames(ocean_temp) <- realm_names
species_names <- as.character(params@species_params$species)
sizes <- params@w

vertical_migration_array <- array(1, dim = (c(length(realm_names),
                                              length(species_names), length(sizes))),
                                  dimnames = list(realm = realm_names, sp = species_names,
                                                  w = signif(sizes, 3)))
```


## setup exposure array

```{r}
exposure_array <- array(0, dim = (c(length(realm_names), length(species_names))), 
                  dimnames = list(realm = realm_names, sp = species_names)) # realm x species

for (r in seq(1,length(realm_names),1)) {
    for (s in seq(1,length(species_names),1)) {
        if (any(vertical_migration_array[r,s,] > 0)) {
            exposure_array[r,s] = 1
        }
    }
}
```




### set up therMizer params

```{r}
# paramsT <- upgradeTherParams(params,
#                              ocean_temp_array = ocean_temp,
#                              n_pp_array = n_pp_array,
#                              vertical_migration_array = vertical_migration_array,
#                              aerobic_effect = TRUE, metabolism_effect = TRUE)
```

Error in upgradeTherParams(new_params, ocean_temp_array = ocean_temp_matrix, :
The size dimension of the n_pp_array must be the same as w_full.

```{r}
# ocean_temp_matrix <- as.matrix(ocean_temp)
# # ocean_temp_test <- abind::abind(ocean_temp, along =2)
# ocean_temp_mat <- as(ocean_temp, "matrix")
```


```{r}
ocean_temp_date <- 1:600
# ocean_temp_date <- ocean_temp_tidy$date_comb

row.names(ocean_temp_tidy) <- ocean_temp_date

# ocean_temp$tos2 <- ocean_temp$tos

# ocean_temp_array <- as.matrix(ocean_temp[,2:3]) # required if adding a dummy second realm
ocean_temp_array <- as.matrix(ocean_temp_tidy[,2])

row.names(ocean_temp_array) <- ocean_temp_date
# 
colnames(ocean_temp_array) <- "tos"
# row.names(ocean_temp_tidy) <- ocean_temp_date


```



```{r}
# paramsT <- upgradeTherParams(params,
#                              ocean_temp_array = ocean_temp_array,
#                              n_pp_array = n_pp_array, 
#                              vertical_migration_array = vertical_migration_array,
#                              exposure_array = exposure_array,
#                              aerobic_effect = TRUE, metabolism_effect = TRUE)


paramsT <- upgradeTherParams(params,
                             ocean_temp_array = ocean_temp_array,
                             n_pp_array = n_pp_array, 
                             # vertical_migration_array = vertical_migration_array,
                             # exposure_array = exposure_array,
                             aerobic_effect = TRUE, metabolism_effect = TRUE)
```

```{r}
plotTherPerformance(paramsT)
```



```{r}
simT <- project(paramsT, t_max = 100)
paramsT <- steady(paramsT)

plot(simT)
plot(paramsT)
```



```{r}
# paramsT_v1 <- calibrateBiomass(paramsT) # rescales kappa - not what we want
# plot(paramsT_v1)

paramsT_tuned <- tuneParams(paramsT)
```



Initial error as the length of n_pp_array was based on a different w_full

Error in upgradeTherParams(new_params, ocean_temp_array = ocean_temp_matrix, :
The size dimension of the n_pp_array must be the same as w_full.

But now I've updated the n_pp_array based on the same w_full length (142 size classes), but it's still flagging an error

Warning: The dimnames of the second dimension of n_pp_array are not the same
      as the ones in w_full. Since the dimension size is the same, the dimnames
      have been replaced by w_full.Error in dimnames(n_pp_array) <- `*vtmp*` : 
  length of 'dimnames' [1] not equal to array extent
  

```{r}
upgradeTherParams
```



```{r}
length(params@w_full)
dim(n_pp_array)
length(n_pp_array)

length(params@dw_full)
```


```{r}
paramsT <- upgradeTherParams(new_params,
                             ocean_temp_array = ocean_temp_matrix,
                             n_pp_array = n_pp_array, 
                             vertical_migration_array = vertical_migration_array,
                             aerobic_effect = TRUE, metabolism_effect = TRUE)
```

## Troubleshooting therMizer errors

To try and fix dimnames error, manually change the n_pp_array colnames with the same as params@w_full 
(i.e., one is Vi and the other is i)

## Calibration notes

Can add matchGrowth() into the matchBiomass()/matchCalibrate() framework

Establish criteria to constrain output
Biomass/catch within +- xx% etc
Diet - ontogenetic shifts for appropriate species etc.

check


### Adding min and max temp for each group

Using sealifebase for all non-fish species/groups. In most cases, there are no listed Temperature values in the 'Environment' section, like there is for more data-rich species, e.g., cod

Instead, there are values at the bottom of the sealifebase pages in 'Estimates of some properties based on models' with 'Preferred temperature' estimates from the AquaMaps model-based approach (https://www.gbif.org/tool/81356/aquamaps-predicted-range-maps-for-aquatic-species)  

[1] "euphausiids":
Antarctic krill - (Preferred temperature (Ref. 115969): -1.5 - 1.6, mean 0.2 (based on 535 cells))
Crystal krill - (Preferred temperature (Ref. 115969): -1.8 - 1.1, mean -1.6 (based on 3588 cells)) 
Thysanoessa macrura - (Preferred temperature (Ref. 115969): -1.2 - 2.8, mean 0.2 (based on 24 cells). Not included due to small number of cells and low contribution to biomass in this model domain
[2]"mesopelagic fishes" - Electrona antarctica(nothing on fishbase)    
[3]"bathypelagic fishes"      
[4]"shelf and coastal fishes":
Marbled rockcod (-1 - 5)
[5]"flying birds":
Southern giant petrel (Preferred temperature (Ref. 115969): 2.1 - 15.6, mean 10.1 (based on 533 cells));
Arctic tern (Sterna paradisaea) (Preferred temperature (Ref. 115969): 0.4 - 13.3, mean 6.8 (based on 2468 cells))
Thalassarche chrysostoma (Grey-headed petrel)  (Preferred temperature (Ref. 115969): 1.3 - 9.1, mean 5.2 (based on 263 cells))
South polar skua (Preferred temperature (Ref. 115969): 0.2 - 18.2, mean 6.4 (based on 1318 cells))
Diomedea exulans (Wandering albatross), (Preferred temperature (Ref. 115969): 0.5 - 12, mean 4.6 (based on 1528 cells)_
[6]"small divers" - no info for adelie, gentoo or crested penguins on sealifebase. Guess based on medium divers       
[7]"squids" - based on Psychroteuthis glacialis (sealifebase)                   
[8]"toothfishes" - no data on fishbase            
[9]"leopard seals" - Preferred temperature (Ref. 115969): -1.9 - 1.4, mean -0.5 (based on 2109 cells).          
[10] "medium divers":
Crabeater Seals - (Preferred temperature (Ref. 115969): -0.4 - 1, mean 0.1 (based on 9397 cells))
Ross seals (Preferred temperature (Ref. 115969): -1.8 - 1.1, mean -1.5 (based on 2110 cells));
Weddell seals (Preferred temperature (Ref. 115969): -1.8 - 1, mean -1.6 (based on 6026 cells));
Hourglass dolphin (Preferred temperature (Ref. 115969): 0.1 - 2, mean 0.9 (based on 11222 cells)) # Not included in the biomass
King penguin (no data on sealifebase)
Emperor penguin (no data on sealifebase)
[11]"large divers" - Southern elephant seals only in this group now that Sperm whales are also seperated         
[12]"minke whales"             
[13]"orca"                     
[14]"sperm whales"             
[15]"baleen whales" 

```{r}
# temp_min <- c(-1.8, # euphausiids
#                                      -2, # mesopelagic fishes
#                                      -2, # bathypelagic fishes
#                                      -1, # "shelf and coastal fishes" 
#                                      0.2, # "flying birds"
#                                      -0.4, # "small divers"             
#                                      -0.8, # "squids"                  
#                                      -2, # "toothfishes"              
#                                      -1.9, # "leopard seals"           
#                                      -0.4, # "medium divers"            
#                                      0.1, # "large divers"             
#                                      0.2, # "minke whales"             
#                                      0.3, # "orca"                     
#                                      0.3, # "sperm whales"             
#                                      0.2,# "baleen whales"
#                                       -2) # salps
# 
# temp_max <- c(1.6, # euphausiids
#                                      5, # mesopelagic fishes
#                                      5, # bathypelagic fishes
#                                      5, # "shelf and coastal fishes" 
#                                      18.2, # "flying birds"
#                                      1, # "small divers"             
#                                      1.1, # "squids"                  
#                                      5, # "toothfishes"              
#                                      1.4, # "leopard seals"           
#                                      1, # "medium divers"            
#                                      1.6, # "large divers"             
#                                      7, # "minke whales"             
#                                      13.1, # "orca"                     
#                                      3.8, # "sperm whales"             
#                                      10.2, # "baleen whales"
#                                       5) # salps
```



