---
title: "FishMIP + IWC Effort Forcing Plot"
output: html_notebook
---

Creating a plot of fishing + whaling effort for SOMEME manuscript figure

Combines line plot with one line for total fishing effort and another line for total whaling effort

```{r}
library(tidyverse)
```


```{r}
df_IWC_effort_Prydz <- read.csv("FishMIP_fishing_data/IWC_effort.csv")

glimpse(df_IWC_effort_Prydz)
```

```{r}
df_IWC_effort_Prydz_tidy <- df_IWC_effort_Prydz %>% 
 dplyr::mutate(Species = case_when(Species == "Antarctic Minke" ~ "Antarctic minke whales",
                             Species == "Baleen" ~ "Baleen whales",
                             Species == "Killer" ~ "Killer whales",
                             Species == "Sperm" ~ "Sperm whales"))
```



```{r}


# Plot
ggplot(df_IWC_effort_Prydz_tidy, aes(x=Year, y=effort_standard , fill=Species)) + 
    geom_area(alpha=0.6 , size=1, colour="black")
```

## FishMIP Effort data

Load in and inspect the master dataframes for historical catch and effort

```{r FishMIP_hist_data, echo=TRUE}
df_FishMIP_effort <- read.csv("FishMIP_fishing_data/effort_histsoc_1841_2010_regional_models.csv")
```


And let's take a glimpse at the two datasets:

```{r glimpse-FishMIP_data}
dplyr::glimpse(df_FishMIP_effort)
```

Check how many regions are included and identify the region of interest, Prydz Bay
```{r unique-region}
unique(df_FishMIP_effort$region)
```

Great, there it is. It's called `Prydz.Bay`

Filter dataframe so now I have the Prydz Bay data only

```{r filter-effort}
df_Prydz_effort <- df_FishMIP_effort %>% 
  dplyr::filter(region == "Prydz.Bay")

head(df_Prydz_effort)
dplyr::glimpse(df_Prydz_effort)
summary(df_Prydz_effort)
```

```{r}
# write.csv(df_Prydz_effort, "FishMIP_fishing_data/effort_histsoc_1841_2010_Prydz_Bay.csv")
```


Time series of effort by functional group
```{r}
df_Prydz_effort %>% 
  ggplot(aes(x = Year, y = NomActive, colour = FGroup)) +
  geom_point() +
  # scale_y_log10() +
  facet_wrap(~FGroup, scales = "free_y")
```

Aggregate `FGroup` so that they align with functional groups in the Prydz Bay size spectrum model

```{r unique_FGroup}
unique(df_Prydz_effort$FGroup)
```


"demersal<30cm" = "shelf and coastal fishes"

"rays<90cm" = NA - not represented in the current functional groups

"benthopelagic30-90cm" = "shelf and coastal fishes"

"benthopelagic>=90cm" = "toothfishes"

"krill" = "antarctic krill"

"pelagic30-90cm" = "shelf and coastal fishes"

"bathydemersal>=90cm" = "toothfishes"

"pelagic<30cm" = "shelf and coastal fishes": When I extracted data at the Marine Ecosystem (ME) level on sea around us for East Antarctic Dronning Maud Land, East Antarctic Enderby Land, and East Antarctic Wilkes Land (which describe the model region better than using the RFMO selection of CCAMLR), all the reported catch fit into the "shelf and coastal fishes" group. At the CCAMLR level, there are significant lanternfish catches, i.e., "mesopelagic fishes"

"lobsterscrab" = NA - not represented in the current functional groups

"cephalopods" = "squids"

"demersal30-90cm" = "shelf and coastal fishes"

"bathypelagic<30cm" = "bathypelagic fishes"

"bathydemersal30-90cm" = "shelf and coastal fishes"



```{r tidy-Prydz-effort}
df_Prydz_effort_prepared <- df_Prydz_effort %>%
  dplyr::mutate(Species = case_when(FGroup == "demersal<30cm" ~ "Shelf and coastal fishes",
                             FGroup == "rays<90cm" ~ "rays<90cm",
                             FGroup == "benthopelagic30-90cm" ~ "Shelf and coastal fishes",
                             FGroup == "benthopelagic>=90cm" ~ "Toothfishes",
                             FGroup == "krill" ~ "Antarctic krill",
                             FGroup == "pelagic30-90cm" ~ "Shelf and coastal fishes",
                             FGroup == "bathydemersal>=90cm" ~ "Toothfishes",
                             FGroup == "pelagic<30cm" ~ "Shelf and coastal fishes",
                             FGroup == "lobsterscrab" ~ "lobsterscrab",
                             FGroup == "cephalopods" ~ "Squids",
                             FGroup == "demersal30-90cm" ~ "Shelf and coastal fishes",
                             FGroup == "bathypelagic<30cm" ~ "Bathypelagic fishes",
                             FGroup == "bathydemersal30-90cm" ~ "Shelf and coastal fishes"
                             )) %>% 
  filter(!FGroup=="rays<90cm" & !FGroup=="lobsterscrab") %>% 
  group_by(Year, Species) %>% 
  summarise(effort = sum(NomActive)) %>% 
  filter(!effort < 1e-15) %>%
  group_by(Species) %>% 
  mutate(max_effort = max(effort)) %>%
  ungroup() %>% 
  group_by(Species,Year) %>%
  mutate(effort_standard = effort/max_effort) %>% 
  ungroup() %>% 
  # dplyr::mutate(species = factor(species),
  #               island = factor(island),
  #               sex = factor(sex),
  #               year = lubridate::year(date_egg)) %>%
  # dplyr::rename(bill_length_mm = culmen_length_mm,
  #               bill_depth_mm = culmen_depth_mm,
  #               delta_15_n = delta_15_n_o_oo,
  #               delta_13_c = delta_13_c_o_oo) %>%
  tidyr::drop_na()

glimpse(df_Prydz_effort_prepared)
head(df_Prydz_effort_prepared)
summary(df_Prydz_effort_prepared)

# saveRDS(df_Prydz_effort_prepared, "FishMIP_fishing_data/effort_Prydz_Bay_1950_2010_resolution_v1.RDS")
```


```{r}
df_IWC_effort_Prydz_tidy$Species <- factor(df_IWC_effort_Prydz_tidy$Species, levels=c("Baleen whales", "Sperm whales", "Killer whales","Antarctic minke whales","Antarctic krill","Squids","Bathypelagic fishes","Shelf and coastal fishes","Toothfishes"))
df_Prydz_effort_prepared$Species <- factor(df_Prydz_effort_prepared$Species, levels=c("Baleen whales", "Sperm whales", "Killer whales","Antarctic minke whales","Antarctic krill","Squids","Bathypelagic fishes","Shelf and coastal fishes","Toothfishes"))

# Plot
ggplot(df_Prydz_effort_prepared, aes(x=Year, y=effort_standard , fill=Species)) + 
    xlab("Year") +
    scale_x_continuous(breaks=seq(1930,2015,10)) +
    ylab("Standardised Effort") +
    geom_area(alpha=0.6 , size=0.2, colour="black") +
    geom_area(data = df_IWC_effort_Prydz, aes(x=Year, y=effort_standard,fill=Species), alpha=0.6 , size=.2, colour="black") +
    # scale_fill_manual(values=c("coral2","grey60","grey32","dodgerblue4","black","dodgerblue2","grey87","orchid2","mediumpurple")) +
    scale_fill_manual(values=c("coral2","dodgerblue2","dodgerblue4","orchid2","mediumpurple","grey87","grey60","grey32", "black")) +
    theme_classic() +
    guides(fill=guide_legend(title="Functional Group")) +
    theme(legend.key.size = unit(1, 'lines'),
          legend.position=c(0.9,0.8),
          legend.background = element_blank(),
          axis.title = element_text(size=14),
          axis.text = element_text(size=13),
           # axis.title.x = element_blank(),
          # plot.tag = element_text(face = 'italic'),
      # axis.text.x=element_text(colour="black", size = 12),
      # axis.text.y=element_text(colour="black", size = 12),
      legend.title=element_text(size=14), 
      legend.text=element_text(size=14))

ggsave("Figure_Fishing_Whaling_Effort_Prydz_Bay_v1.png",
       units="mm",
       dpi = 600,
       width = 300,
       height =200)
  
```

































Load steady therMizer parameters:
Temperature and resource information included
```{r}
# Generate parameters
params <- readRDS("therMizer_params_v04.RDS")

spp.names <- params@species_params$species
```


Read in effort array
```{r}
effort_array <- read.csv("FishMIP_fishing_data/effort_array.csv")

glimpse(effort_array)
```

```{r}
# time_steps_effort <- 1961:2010
# isimip_effort <- effort_array
# 
# years <- isimip_effort[,1]
# 
# isimip_effort <- isimip_effort[,-1]
# rownames(isimip_effort) <- years
# 
# # colnames(isimip_effort) <- rownames(gear_params(params))
# # colnames(isimip_effort) <-  gear_params(params)$gear # rep("kinfe_edge_gear",19)
#  # colnames(isimip_effort) <- rep("knife_edge_gear",19)
#  
# for (i in 1:ncol(isimip_effort)) {
#   colnames(isimip_effort)[i] <- "knife_edge_gear"
# }
# 
# head(isimip_effort)
# glimpse(isimip_effort)
# dim(isimip_effort)
# 
# effort_1961_2010 <- isimip_effort[-c(1:31,82:90),]
# 
# isimip_effort_array <- as(effort_1961_2010, "matrix")
# 
# gear_name = colnames(isimip_effort)
# 
# 
# effort_array <- array(NA, c(length(time_steps_effort), length(gear_name)), dimnames = list(time = time_steps_effort, gear = gear_name))
# effort_array[1,] = isimip_effort_array[1,]
# for (t in seq(1,length(time_steps_effort) - 1, 1)) {
#   effort_array[t + 1,] <- isimip_effort_array[t + 1,]
# }
# 
# effort_array[is.na(effort_array)] <- 0
# 
# glimpse(effort_array)

```

```{r}
time_steps_effort <- 1961:2010
isimip_effort <- effort_array

years <- isimip_effort[,1]

isimip_effort <- isimip_effort[,-1]
rownames(isimip_effort) <- years


effort_1961_2010 <- isimip_effort[-c(1:31,82:90),]

isimip_effort_array <- as(effort_1961_2010, "matrix")

gear_name = colnames(isimip_effort)


effort_array <- array(NA, c(length(time_steps_effort), length(gear_name)), dimnames = list(time = time_steps_effort, gear = gear_name))
effort_array[1,] = isimip_effort_array[1,]
for (t in seq(1,length(time_steps_effort) - 1, 1)) {
  effort_array[t + 1,] <- isimip_effort_array[t + 1,]
}

effort_array[is.na(effort_array)] <- 0

glimpse(effort_array)
```

species.labs <- c("Antarctic krill", "Bathypelagic fishes", "Shelf & Coastal fishes", "Squids", "Toothfishes", "Antarctic minke whales", "Orcas", "Sperm whales", "Baleen whales")
names(species.labs) <- c("antarctic krill", "bathypelagic fishes", "shelf and coastal fishes", "squids", "toothfishes", "minke whales", "orca", "sperm whales", "baleen whales")

```{r}

df_plot_wide <- effort_array

effort_ts <- effort_array %>% 
  melt()

head(effort_ts)

names(effort_ts) <- c("Year", "Species", "Norm_Effort")

effort_ts_tidy <- effort_ts %>% 
  filter(Species == "shelf and coastal fishes" |
           Species == "antarctic krill" |
           Species == "squids" |
           Species == "bathypelagic fishes" |
           Species == "toothfishes" |
           Species == "minke whales" |
           Species == "baleen whales"|
           Species == "orca"|
           Species == "sperm whales") 

# %>%
  # filter(!Norm_Effort == 0)

glimpse(effort_ts_tidy)
head(effort_ts_tidy)
```


```{r}
# New facet label names for species
species.labs <- c("Antarctic krill", "Bathypelagic fishes", "Shelf & Coastal fishes", "Squids", "Toothfishes", "Antarctic minke whales", "Orcas", "Sperm whales", "Baleen whales")
names(species.labs) <- c("antarctic krill", "bathypelagic fishes", "shelf and coastal fishes", "squids", "toothfishes", "minke whales", "orca", "sperm whales", "baleen whales")

# df_mod_yield <- plotYield(projection_steady_F, return_data = T)

# p_effort <-  
  # effort_ts_tidy %>%
  # ggplot() +
  
  # p_effort <-  
    effort_ts %>%
      # filter(Species == "antartic.krill") %>% 
  ggplot() +
  
  # facet_wrap(~Species,scales="free_y") +
  geom_point(data = effort_ts, aes(x = Year, y = Norm_Effort, colour = Species), size=1) +
  geom_point(data = effort_ts, aes(x = Year, y = Norm_Effort), shape = 1,size = 1,colour = "black") +
    geom_line(data = effort_ts, aes(x = Year, y = Norm_Effort, colour = Species), linewidth=1) +
    facet_wrap(~Species,scales="free_y",
             labeller = labeller(Species = species.labs)) +
  labs(fill = "Functional group") +
  theme(legend.title = element_text( size=3), legend.text=element_text(size=3)) + 
  geom_vline(aes(xintercept = 1961), linetype = "dashed") + 
  geom_vline(aes(xintercept = 2010), linetype = "dashed") +
  theme_classic() +
  theme(
    legend.position = "none"
  )
```


