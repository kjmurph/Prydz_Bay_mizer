---
title: "Example for Scott"
output: html_notebook
---

## Resources

How to start from scratch: https://course.mizer.sizespectrum.org/understand/

Blogs: https://blog.mizer.sizespectrum.org/

```{r}
# remotes::install_github("sizespectrum/mizerHowTo")
library(mizerHowTo)
```

https://github.com/sizespectrum/mizerHowTo

Time-averaged, steady-state size spectrum model representing Prydz Bay ecosystem using biomass values from the balanced Ecopath model published in McCormack et al. 2020 (10.1016/j.dsr2.2019.07.001) for calibration. The time-averaged steady-state roughly represents 2010-2019

The size spectrum model consists of 19 species/functional groupings.

Species parameters of importance:
- Minimum, maturation, and maximum sizes (`w_min`, `w_mat`, and `w_max`)
- predator-prey mass ratio, `beta`
- `biomass_observed`, or in this case the balanced biomass from an Ecopath model that used compiled empirical observation of biomasses for each species
- `Rmax`, the maximum reproduction rate

## What areas could be improved

Identifying patterns in model output to suggest steps to improve model
Capturing macro/meta trends in growth curve responses etc

## Load libraries

```{r}
remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental) # dev version
install.packages('mizer')
library(mizer) # base mizer
# library(therMizer)
library(tidyverse)
```


## Initial estimate for kappa (system carrying capacity)

Phase 1
Kappa starting point: use value of 10 t/km^2 from McCormack et al. 2020 to establish a steady model.
Match model to time-averaged fishing (catch)

Other ways to estimate kappa:
Then use historical FishMIP values to estimate the profile of the phytoplakton size spectrum
ACEAS data:
Can we get empirical phytoplankton or zooplankton size spectra (BCG ARGO floats or particle counters) Jase Everett or ACEAS folks

Using pico (6.94559e-11) and large (6.06131e-07)  phyto midpoints from Phoebe's method as the assumed phytoplankton size range. 'Spread' the biomass estimate from McCormack of 10 t/km^2 across that size range and using Barnes equation to estimate the density at the intercept (density per gram at 0 on log scale): kappa = 17.9 

Kappa for the whole model domain is 17.9 * 1.474341e+12 = 2.63907e+13

Setting kappa:
How do we want to express the model domain. m^2 or the entire domain volume?
Banzare Bank model domain is 1.474341e+12 [m^2]

## Load model parameter object

```{r}
base_params <- readRDS("params/base_params.RDS")
params <- readRDS("params_latest_biomass_09_Aug_2023.RDS")
```

Species parameters

What are the main parameters to tweak in a clibration workflow

beta: prep-prey mass ratio can be adjusted

Main metrics to use for calibration (compare mizer model biomass to observed biomass) Figure xx
- biomass_observed (the balanced model values from McCormack et al. 2020)
- Other examples would be fisheries catch....

Parameters that can be optimised 
- gamma
- beta
- sigma
- erepro
- Rmax

How is 

```{r}
spp_params <- params@species_params
spp_params
```


Interaction matrix is what drives encounter between between pred-prey
Also how we factor in migration (if whale is only in model domain for summer, value would be 0.5)
```{r}
int_matrix <- params@interaction
int_matrix
```


```{r}
base_sim <- project(base_params, t_max = 100)

sim <- project(params, t_max = 100)


plot(sim)
plot(base_sim)

plotBiomassRelative(sim)
```
## Tuning model using shiny app
```{r}
base_tuned <- tuneParams(base_params)
params_tuned <- tuneParams(params)

```


## Figure xx

```{r}
plotBiomassObservedVsModel(params)
plotBiomassObservedVsModel(base_params)
```


## Inspect species params

Many of these are not used and mizer has a lot of under the hood stuff going on to set a lot of rates and parameters. Happy to dig into that stuff in a meeting if you're keen to learn more.
```{r}
params@species_params
```

```{r}
params_v2 <- params %>% steady() %>%  
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000) %>%
  matchBiomasses() %>% steady(tol = 0.0005, t_max = 2000)
```
Convergence was achieved in 1.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, large divers, minke whalesConvergence was achieved in 846 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, medium divers, large divers, minke whalesConvergence was achieved in 418.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krillConvergence was achieved in 426 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, medium divers, large divers, minke whalesConvergence was achieved in 400.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krillConvergence was achieved in 336 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, medium divers, large divers, minke whalesConvergence was achieved in 330 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krillConvergence was achieved in 262.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, medium divers, large divers, minke whalesConvergence was achieved in 222 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krillConvergence was achieved in 139.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, large divers, minke whalesConvergence was achieved in 46.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, large divers, minke whalesConvergence was achieved in 1.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, large divers, minke whalesConvergence was achieved in 1.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, large divers, minke whalesConvergence was achieved in 1.5 years.
Warning: The following species require an unrealistic reproductive efficiency greater than 1: mesozooplankton, other krill, other macrozooplankton, antarctic krill, flying birds, leopard seals, large divers, minke whales


```{r}
initial_effort(params_v2)
```
```{r}
sim_1 <- project(params_v2, t_max = 1000, effort = 0)

sim_1.1 <- project(params_v2, t_max = 500, effort = 0, 
                         initial_n = sim_1@n[1000,,])

plotBiomass(sim_1.1)
plotBiomassRelative(sim_1.1)
```


```{r}
sim_2 <- project(params_v2, t_max = 500, effort = 0, 
                         initial_n = sim_1@n[500,,])

plot(sim_2)
plotlyBiomass(sim_2)
```


```{r}
sim_fishing_v01 <- project(params, t_max = 500, effort = 0)
```
## Check steady-state biomass

```{r}
plot(sim_fishing_v01)
```

Make sure that there is no change in biomass over a long time period
```{r}
plotBiomassRelative(sim_2)
```



```{r}
getReproductionLevel(params)
```

## Check biomass and yield values currently

```{r}
species_params(params)$biomass_observed
species_params(params)$yield_observed
gear_params(params)$yield_observed
```

Currently, observed biomass is in g/m2 (same as t/km2), so need to scale biomass using the model domain in m2

Scale this up to biomass values for the entire model domain (1474341km^2)

1474341 * 1e6 for m2 = 1.474341e+12

```{r}
species_params(params)$biomass_observed <- species_params(params)$biomass_observed * 1.474341e+12
species_params(params)$yield_observed <- species_params(params)$yield_observed * 1.474341e+12
gear_params(params)$yield_observed <- gear_params(params)$yield_observed * 1.474341e+12

species_params(params)$biomass_observed
species_params(params)$yield_observed
gear_params(params)$yield_observed
```


Now biomass and yield are expressed as units (grams) per whole model domain

Still steady?

```{r}
params_upscaled <- steady(params, tol = 0.001, t_max = 1000) |>
    matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |> matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |>
    matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |> matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |>
    matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |> matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |>
    matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |> matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |>
    matchBiomasses() |> steady(tol = 0.001, t_max = 1000) |> matchBiomasses() |> steady(tol = 0.001, t_max = 1000)
```

```{r}
sim_fishing_v02 <- project(params, t_max = 500, effort = 0.2)
```

## Check steady-state biomass

```{r}
plot(sim_fishing_v02)
```


tune params to new biomasses, make sure steady and save update

```{r}
params <- tuneParams(params)

# saveRDS(params, "therMizer_params_total_area.RDS")

params_test <- readRDS("therMizer_params_total_area.RDS")
```
